<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Gift Card Tracker</title>
    <style>
      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at 20% 20%, #1f2b55, #080d1c 60%);
        color: #f5f7ff;
        font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      }
      .status {
        color: #9bb0ff;
        font-size: .95rem;
      }
      .status.error {
        color: #ff9b9b;
      }
      .card {
        width: min(1200px, 96vw);
        background: rgba(10, 18, 35, 0.85);
        border-radius: 28px;
        padding: 2rem;
        border: 1px solid #1f2d51;
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.45);
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .back-btn {
        position: fixed;
        top: 18px;
        left: 18px;
        border: 1px solid #243258;
        background: rgba(10, 18, 35, 0.85);
        color: #9bb0ff;
        padding: .45rem .75rem;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
      }
      .back-btn:hover {
        color: #cfe0ff;
        border-color: #4b7bff;
      }
      h1 {
        margin: 0;
        font-size: 2rem;
      }
      p {
        margin: 0;
        color: #a4b6e6;
      }
      .tabs {
        display: flex;
        gap: .6rem;
        flex-wrap: wrap;
      }
      .view-tabs {
        display: flex;
        gap: .6rem;
        flex-wrap: wrap;
        margin-top: .5rem;
      }
      .view-tab {
        border: 1px solid #243258;
        background: transparent;
        color: #dbe3ff;
        padding: .45rem 1.1rem;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: .03em;
      }
      .view-tab.active {
        border-color: #4b7bff;
        color: #fff;
        background: rgba(75, 123, 255, 0.2);
        box-shadow: 0 0 18px rgba(75, 123, 255, 0.3);
      }
      .tab {
        border: 1px solid #243258;
        background: #0f1831;
        color: #dbe3ff;
        padding: .5rem 1rem;
        border-radius: 12px;
        cursor: pointer;
      }
      .tab.active {
        border-color: #4b7bff;
        box-shadow: 0 0 0 1px rgba(75, 123, 255, 0.4);
      }
      .hidden {
        display: none !important;
      }
      .auth-gate {
        position: fixed;
        inset: 0;
        background: rgba(7, 13, 25, 0.88);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        z-index: 50;
      }
      .auth-panel {
        width: min(420px, 90vw);
        background: #0a1326;
        border: 1px solid #26345c;
        border-radius: 20px;
        padding: 1.6rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.5);
      }
      .auth-panel h2 {
        margin: 0;
      }
      .auth-panel form {
        display: flex;
        flex-direction: column;
        gap: .7rem;
      }
      .auth-panel label {
        display: flex;
        flex-direction: column;
        gap: .4rem;
        font-size: .85rem;
        color: #9bb0ff;
      }
      .auth-panel input {
        border-radius: 10px;
        border: 1px solid #243258;
        background: #050b1c;
        color: #f5f7ff;
        padding: .55rem .6rem;
        font-size: 1rem;
      }
      .auth-status {
        min-height: 1.4rem;
        font-size: .9rem;
        color: #9bb0ff;
      }
      .auth-status.error {
        color: #ff9b9b;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        color: #dbe3ff;
        font-size: .95rem;
      }
      th, td {
        border: 1px solid #10172c;
        padding: .55rem .7rem;
        text-align: center;
      }
      thead th {
        background: #0f1f40;
        text-transform: uppercase;
        font-size: .8rem;
        letter-spacing: .05em;
      }
      tbody tr:nth-child(odd) {
        background: rgba(255, 255, 255, 0.02);
      }
      input[type="number"] {
        width: 100%;
        padding: .35rem .4rem;
        border-radius: 8px;
        border: 1px solid #243258;
        background: #0a1223;
        color: #f5f7ff;
        text-align: right;
      }
      input[type="number"]:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        color: #98a4c4;
      }
      .mode-pill {
        align-self: flex-start;
        padding: .35rem .75rem;
        border-radius: 999px;
        border: 1px solid #2a365a;
        background: rgba(255,255,255,0.05);
        color: #9bb0ff;
        font-weight: 600;
        font-size: .9rem;
      }
      .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
      }
      .panel {
        background: rgba(7, 14, 28, 0.6);
        border: 1px solid #1d2747;
        border-radius: 22px;
        padding: 1.5rem;
        margin-top: 1.2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .panel-header {
        display: flex;
        flex-wrap: wrap;
        gap: .6rem;
        justify-content: space-between;
        align-items: center;
      }
      .panel h2 {
        margin: 0;
        font-size: 1.3rem;
      }
      .panel-subtitle {
        margin: 0;
        color: #91a3de;
        font-size: .95rem;
      }
      .cobrand-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
      }
      .form-field {
        display: flex;
        flex-direction: column;
        gap: .35rem;
      }
      .form-field label {
        text-transform: uppercase;
        font-size: .8rem;
        letter-spacing: .08em;
        color: #9bb0ff;
      }
      .form-field input,
      .form-field select {
        border-radius: 10px;
        border: 1px solid #243258;
        background: #050b1c;
        color: #f5f7ff;
        padding: .5rem .6rem;
        font-size: 1rem;
      }
      .form-field input::placeholder {
        color: #506097;
      }
      .field-hint {
        font-size: .8rem;
        color: #8795c4;
      }
      .form-field.full-row {
        grid-column: 1 / -1;
      }
      .file-input {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      .logo-preview {
        width: 72px;
        height: 72px;
        border-radius: 16px;
        border: 1px dashed #2a3c70;
        background: #0a152d;
        object-fit: contain;
      }
      .seller-field {
        position: relative;
      }
      .seller-input {
        position: relative;
      }
      .seller-suggestions {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        background: #070f25;
        border: 1px solid #243258;
        border-radius: 12px;
        max-height: 230px;
        overflow-y: auto;
        z-index: 20;
        padding: 0;
        margin: 0;
      }
      .seller-suggestions.hidden {
        display: none;
      }
      .seller-suggestions li {
        list-style: none;
        padding: .5rem .7rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: .5rem;
      }
      .seller-suggestions li.muted {
        cursor: default;
        color: #6d78a6;
      }
      .seller-suggestions li:hover:not(.muted) {
        background: rgba(75, 123, 255, 0.15);
      }
      .tag {
        font-size: .7rem;
        text-transform: uppercase;
        letter-spacing: .08em;
        border: 1px solid #2f3f6b;
        border-radius: 999px;
        padding: .1rem .4rem;
        color: #9bb0ff;
      }
      .form-actions {
        display: flex;
        flex-wrap: wrap;
        gap: .8rem;
        align-items: center;
      }
      .primary-btn {
        background: linear-gradient(120deg, #566ff8, #8c68ff);
        border: none;
        border-radius: 12px;
        color: #fff;
        padding: .6rem 1.4rem;
        font-weight: 600;
        cursor: pointer;
      }
      .primary-btn:disabled {
        opacity: .6;
        cursor: not-allowed;
      }
      .ghost-btn {
        border: 1px solid #2c3c68;
        background: transparent;
        color: #dbe3ff;
        border-radius: 12px;
        padding: .4rem 1rem;
        cursor: pointer;
      }
      .table-scroll {
        overflow-x: auto;
      }
      .split-table {
        margin-top: 1rem;
      }
      .split-title {
        margin: 0 0 .5rem;
        font-size: .95rem;
        text-transform: uppercase;
        letter-spacing: .08em;
        color: #9bb0ff;
      }
      .cobrands-table th[data-sort] {
        cursor: pointer;
        user-select: none;
      }
      .cobrands-table th[data-sort]::after {
        content: attr(data-direction);
        font-size: .75rem;
        padding-left: .35rem;
        color: #7d8ec2;
      }
      .cobrands-table th[data-sort]:not(.sorted)::after {
        content: "";
      }
      th.sortable {
        cursor: pointer;
        user-select: none;
      }
      .actions-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: .8rem;
        margin: .6rem 0;
      }
      .draw-row {
        display: flex;
        flex-wrap: wrap;
        gap: .8rem;
        align-items: center;
        margin-top: .6rem;
      }
      .draw-btn {
        background: linear-gradient(135deg, #ff8c42, #ff5f6d);
        color: #fff;
        border: none;
        border-radius: 12px;
        padding: .65rem 1.4rem;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 10px 30px rgba(255, 105, 97, 0.4);
      }
      .draw-btn:disabled {
        opacity: .6;
        cursor: not-allowed;
        box-shadow: none;
      }
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.65);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
        backdrop-filter: blur(4px);
      }
      .overlay.visible {
        display: flex;
      }
      .draw-modal {
        width: min(480px, 92vw);
        background: radial-gradient(circle at 20% 20%, #1f2948, #0b1122 70%);
        border: 1px solid #24345d;
        border-radius: 20px;
        padding: 1.4rem;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        color: #e8edff;
      }
      .draw-roller {
        height: 120px;
        overflow: hidden;
        border: 1px solid #24345d;
        border-radius: 14px;
        background: #050b1c;
        position: relative;
        margin: 1rem 0;
      }
      .draw-list {
        display: flex;
        flex-direction: column;
        gap: .6rem;
        padding: .8rem;
        transform: translateY(0);
        transition: transform 1.6s cubic-bezier(0.12, 0.76, 0.35, 1);
      }
      .draw-list .name {
        text-align: center;
        font-weight: 700;
        letter-spacing: .02em;
      }
      .winner-highlight {
        text-align: center;
        font-size: 1.3rem;
        font-weight: 800;
        margin-top: .5rem;
        color: #8ef7a4;
      }
      .history-list {
        margin-top: .8rem;
        border: 1px solid #1f2d51;
        border-radius: 12px;
        padding: .6rem .8rem;
        background: rgba(255,255,255,0.03);
        max-height: 220px;
        overflow-y: auto;
      }
      .history-list ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: .3rem;
      }
      .history-list li {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        font-size: .95rem;
        color: #cfd6ff;
      }
      .tag-sm {
        font-size: .75rem;
        border: 1px solid #2f3f6b;
        padding: .05rem .4rem;
        border-radius: 999px;
        color: #9bb0ff;
      }
      .form-modal {
        width: min(520px, 94vw);
        background: #0b1228;
        border: 1px solid #1f2f54;
        border-radius: 16px;
        padding: 1.2rem;
        box-shadow: 0 20px 60px rgba(0,0,0,0.45);
        color: #e5ebff;
      }
      .form-modal h3 {
        margin: 0 0 .5rem 0;
      }
      .form-group {
        display: flex;
        flex-direction: column;
        gap: .2rem;
        margin-bottom: .8rem;
      }
      .form-group label {
        font-size: .9rem;
        color: #9bb0ff;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        background: #050b1c;
        border: 1px solid #243258;
        border-radius: 10px;
        color: #fff;
        padding: .55rem .6rem;
      }
      @keyframes pulseGlow {
        0% { box-shadow: 0 0 0 0 rgba(86, 111, 248, 0.5); }
        50% { box-shadow: 0 0 0 8px rgba(86, 111, 248, 0.0); }
        100% { box-shadow: 0 0 0 0 rgba(86, 111, 248, 0.0); }
      }
      .pulse {
        animation: pulseGlow 1.6s ease-out infinite;
      }
    </style>
  </head>
  <body>
    <button class="back-btn" onclick="window.location.href='/static/index.html'">← Back</button>
    <div class="card">
      <div class="header-row">
        <div>
          <h1>Gift Card Tracker</h1>
          <p id="mode-subtitle">Loading mode...</p>
        </div>
        <div id="mode-pill" class="mode-pill">Checking role...</div>
      </div>
      <div class="view-tabs" id="view-tabs">
        <button class="view-tab active" type="button" data-view="weekly">Weekly Tracker</button>
        <button class="view-tab" type="button" data-view="cobrands">Cobrands</button>
        <button class="view-tab" type="button" data-view="christmas">12 Days of Christmas</button>
        <button class="view-tab" type="button" data-view="payouts">Payouts</button>
      </div>
      <section id="weekly-view">
        <div class="actions-row">
          <label style="color:#9bb0ff;">Season:</label>
          <select id="season-select" style="background:#050b1c;border:1px solid #243258;border-radius:10px;color:#fff;padding:.4rem .6rem;"></select>
          <button class="ghost-btn" type="button" id="add-season-btn">Add Year</button>
        </div>
        <div class="tabs" id="tabs"></div>
        <div class="actions-row">
          <label style="color:#9bb0ff;">Roster date:</label>
          <input id="roster-date" type="date" style="background:#050b1c;border:1px solid #243258;border-radius:10px;color:#fff;padding:.4rem .6rem;" />
          <label style="color:#9bb0ff;">Store:</label>
          <input id="roster-store" type="number" min="1" value="1" style="width:80px;background:#050b1c;border:1px solid #243258;border-radius:10px;color:#fff;padding:.4rem .6rem;" />
          <button class="ghost-btn" type="button" id="load-roster-btn">Load Roster</button>
          <div class="status" id="roster-status"></div>
        </div>
        <div class="actions-row">
          <button class="primary-btn" type="button" id="save-week-btn">Save Week</button>
          <button class="ghost-btn" type="button" id="refresh-week-btn">Reload Week</button>
          <div class="status" id="weekly-status"></div>
        </div>
        <div class="table-scroll">
          <div class="split-table">
            <div class="split-title">Active roster</div>
            <table>
              <thead>
                <tr class="weekly-head-row" id="weekly-head-row-active"></tr>
              </thead>
              <tbody id="table-body-active"></tbody>
            </table>
          </div>
          <div class="split-table hidden" id="inactive-roster-section">
            <div class="split-title">Other servers</div>
            <table>
              <thead>
                <tr class="weekly-head-row" id="weekly-head-row-inactive"></tr>
              </thead>
              <tbody id="table-body-inactive"></tbody>
            </table>
          </div>
        </div>
      </section>
      <section id="cobrands-view" class="hidden">
        <div class="panel">
          <div class="panel-header">
            <div>
              <h2>Create Cobrand Deal</h2>
              <p class="panel-subtitle">Store details and logos for every partnership.</p>
            </div>
          </div>
          <form id="cobrand-form" class="cobrand-form" autocomplete="off">
            <div class="form-field full-row">
              <label for="company-name">Company Name *</label>
              <input id="company-name" type="text" required placeholder="e.g., Downtown Bakery" />
            </div>
            <div class="form-field">
              <label for="cobrand-amount">Amount (USD) *</label>
              <input id="cobrand-amount" type="text" inputmode="decimal" placeholder="$0.00" required />
            </div>
            <div class="form-field">
              <label for="commission-date">Date of Commission</label>
              <input id="commission-date" type="date" />
            </div>
            <div class="form-field">
              <label for="payment-date">Date of Payment</label>
              <input id="payment-date" type="date" />
            </div>
            <div class="form-field">
              <label for="pickup-date">Date of Pickup</label>
              <input id="pickup-date" type="date" />
            </div>
            <div class="form-field seller-field full-row">
              <label for="seller-input">Seller</label>
              <div class="seller-input">
                <input id="seller-input" type="text" placeholder="Search active servers or managers" autocomplete="off" />
                <input type="hidden" id="seller-id" />
                <ul id="seller-suggestions" class="seller-suggestions hidden"></ul>
              </div>
              <div class="field-hint">Start typing at least 2 characters to search.</div>
            </div>
            <div class="form-field full-row">
              <label for="logo-input">Company Logo</label>
              <div class="file-input">
                <input id="logo-input" type="file" accept="image/*" />
                <img
                  id="logo-preview"
                  class="logo-preview"
                  alt="Logo preview"
                  src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
                />
              </div>
              <div class="field-hint">Images are automatically resized to 128×128.</div>
            </div>
            <div class="form-field full-row">
              <div class="form-actions">
                <button class="primary-btn" type="submit" id="save-cobrand">Save Deal</button>
                <button class="ghost-btn" type="button" id="reset-cobrand">Reset</button>
                <div class="status" id="cobrand-form-status"></div>
              </div>
            </div>
          </form>
        </div>
        <div class="panel">
          <div class="panel-header">
            <h2>Saved Cobrand Deals</h2>
            <button class="ghost-btn" type="button" id="refresh-cobrands">Refresh</button>
          </div>
          <div class="status" id="cobrand-status"></div>
          <div class="table-scroll">
            <table class="cobrands-table">
              <thead id="cobrands-head">
                <tr>
                  <th data-sort="company_name">Company</th>
                  <th data-sort="amount">Amount</th>
                  <th data-sort="date_of_commission">Commission</th>
                  <th data-sort="date_of_payment">Payment</th>
                  <th data-sort="date_of_pickup">Pickup</th>
                  <th>Seller</th>
                  <th>Logo</th>
                  <th data-sort="created_at">Created</th>
                </tr>
              </thead>
              <tbody id="cobrands-body">
                <tr>
                  <td colspan="8" style="text-align:center;color:#8ea0d6;">Switch to the Cobrands tab to load deals.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
      <section id="christmas-view" class="hidden">
        <div class="panel">
          <div class="panel-header">
            <div>
              <h2>12 Days of Christmas</h2>
              <p class="panel-subtitle">Track gift card sales for the 12 days leading up to Dec 24.</p>
            </div>
            <div class="status" id="christmas-status"></div>
          </div>
          <div class="draw-row">
            <button class="draw-btn" type="button" id="draw-btn">Draw Winner</button>
            <button class="ghost-btn" type="button" id="reset-draws-btn">Reset Draws</button>
            <button class="ghost-btn" type="button" id="view-results-btn">View Results</button>
            <div class="status" id="draw-status"></div>
          </div>
          <div class="table-scroll">
            <table>
              <thead>
                <tr id="christmas-head-row">
                  <th>Employee</th>
                </tr>
              </thead>
              <tbody id="christmas-body">
                <tr>
                  <td colspan="15" style="text-align:center;color:#8ea0d6;">No data loaded yet.</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="history-list">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <strong>Draw History</strong>
              <span class="tag-sm" id="draws-remaining">12 gifts left</span>
            </div>
            <ul id="draw-history-list">
              <li style="color:#8ea0d6;">No draws yet.</li>
            </ul>
          </div>
        </div>
      </section>
      <section id="payouts-view" class="hidden">
        <div class="panel">
          <div class="panel-header">
            <div>
              <h2>Payouts</h2>
              <p class="panel-subtitle">Manage tiers, rules, prizes, and see per-employee payouts.</p>
            </div>
          </div>
          <div class="actions-row">
            <button class="primary-btn" type="button" id="refresh-payouts-btn">Refresh Payouts</button>
            <button class="ghost-btn" type="button" id="add-tier-btn">Add Tier</button>
            <button class="ghost-btn" type="button" id="add-rule-btn">Add Rule</button>
            <button class="ghost-btn" type="button" id="add-prize-btn">Add Prize</button>
            <div class="status" id="payouts-status"></div>
          </div>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>Employee</th>
                  <th>Tier Payout</th>
                  <th>Rule Bonus</th>
                  <th>Misc</th>
                  <th>Prizes</th>
                  <th>Total</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="payouts-body">
                <tr><td colspan="7" style="text-align:center;color:#8ea0d6;">No payout data loaded.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="panel">
          <h3 style="margin:0 0 .4rem 0;">Tiers</h3>
          <ul id="tier-list" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:.35rem;">
            <li style="color:#8ea0d6;">No tiers yet.</li>
          </ul>
          <h3 style="margin:1rem 0 .4rem 0;">Rules</h3>
          <ul id="rule-list" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:.35rem;">
            <li style="color:#8ea0d6;">No rules yet.</li>
          </ul>
          <h3 style="margin:1rem 0 .4rem 0;">Prizes</h3>
          <ul id="prize-list" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:.35rem;">
            <li style="color:#8ea0d6;">No prizes yet.</li>
          </ul>
        </div>
      </section>
    </div>
    <div id="auth-gate" class="auth-gate hidden">
      <div class="auth-panel">
        <div>
          <h2>Sign in required</h2>
          <p>Log in to access gift card data.</p>
        </div>
        <form id="auth-gate-form">
          <label>
            Email
            <input id="auth-email" type="email" placeholder="you@example.com" required />
          </label>
          <label>
            Password
            <input id="auth-password" type="password" placeholder="Your password" required />
          </label>
          <button type="submit" class="primary-btn">Sign in</button>
        </form>
        <div id="auth-gate-status" class="auth-status"></div>
      </div>
    </div>
    <script>
      const UNIVERSAL_GOAL = 4000;
      const LOGO_PLACEHOLDER = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
      const days = ['Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday', 'Monday'];
      const fallbackServers = [
        'Alex Thompson',
        'Brianna Lopez',
        'Carlos Mendoza',
        'Danielle Harper',
        'Ethan Brooks',
        'Faith Reynolds',
      ];
      const weeksCount = 8;

      const tabsEl = document.getElementById('tabs');
      const weeklyHeadRows = Array.from(document.querySelectorAll('.weekly-head-row'));
      const activeTbody = document.getElementById('table-body-active');
      const inactiveTbody = document.getElementById('table-body-inactive');
      const inactiveRosterSection = document.getElementById('inactive-roster-section');
      const rosterDateInput = document.getElementById('roster-date');
      const rosterStoreInput = document.getElementById('roster-store');
      const loadRosterBtn = document.getElementById('load-roster-btn');
      const rosterStatus = document.getElementById('roster-status');
      const modePill = document.getElementById('mode-pill');
      const modeSubtitle = document.getElementById('mode-subtitle');
      const statusMsg = document.createElement('div');
      statusMsg.className = 'status';
      document.querySelector('.card').appendChild(statusMsg);
      const COOKIE_MAX_AGE = 60 * 60 * 24 * 7;

      const viewTabsWrapper = document.getElementById('view-tabs');
      const weeklyView = document.getElementById('weekly-view');
      const cobrandsView = document.getElementById('cobrands-view');
      const christmasView = document.getElementById('christmas-view');
      const payoutsView = document.getElementById('payouts-view');
      const seasonSelect = document.getElementById('season-select');
      const addSeasonBtn = document.getElementById('add-season-btn');
      const saveWeekBtn = document.getElementById('save-week-btn');
      const refreshWeekBtn = document.getElementById('refresh-week-btn');
      const weeklyStatus = document.getElementById('weekly-status');
      const cobrandForm = document.getElementById('cobrand-form');
      const cobrandFormStatus = document.getElementById('cobrand-form-status');
      const cobrandStatus = document.getElementById('cobrand-status');
      const cobrandTableBody = document.getElementById('cobrands-body');
      const cobrandTableHead = document.getElementById('cobrands-head');
      const refreshCobrandsBtn = document.getElementById('refresh-cobrands');
      const christmasHeadRow = document.getElementById('christmas-head-row');
      const christmasBody = document.getElementById('christmas-body');
      const christmasStatus = document.getElementById('christmas-status');
      const drawBtn = document.getElementById('draw-btn');
      const drawStatus = document.getElementById('draw-status');
      const drawHistoryList = document.getElementById('draw-history-list');
      const drawsRemaining = document.getElementById('draws-remaining');
      const resetDrawsBtn = document.getElementById('reset-draws-btn');
      const viewResultsBtn = document.getElementById('view-results-btn');
      const payoutsStatus = document.getElementById('payouts-status');
      const payoutsBody = document.getElementById('payouts-body');
      const tierList = document.getElementById('tier-list');
      const ruleList = document.getElementById('rule-list');
      const prizeList = document.getElementById('prize-list');
      const refreshPayoutsBtn = document.getElementById('refresh-payouts-btn');
      const addTierBtn = document.getElementById('add-tier-btn');
      const addRuleBtn = document.getElementById('add-rule-btn');
      const addPrizeBtn = document.getElementById('add-prize-btn');
      const companyNameInput = document.getElementById('company-name');
      const amountInput = document.getElementById('cobrand-amount');
      const commissionInput = document.getElementById('commission-date');
      const paymentInput = document.getElementById('payment-date');
      const pickupInput = document.getElementById('pickup-date');
      const sellerInput = document.getElementById('seller-input');
      const sellerIdInput = document.getElementById('seller-id');
      const sellerSuggestions = document.getElementById('seller-suggestions');
      const logoInput = document.getElementById('logo-input');
      const logoPreview = document.getElementById('logo-preview');
      const resetCobrandBtn = document.getElementById('reset-cobrand');
      const saveCobrandBtn = document.getElementById('save-cobrand');

      let isAdmin = false;
      let currentWeek = 1;
      let giftData = {};
      let serverNames = [];
      let cobrandsLoaded = false;
      let cobrandDeals = [];
      let cobrandSort = { field: 'created_at', direction: 'desc' };
      let compressedLogoData = null;
      let sellerSearchTimeout;
      let sellerSearchAbort;
      let isSavingCobrand = false;
      let giftTrackerLoaded = false;
      let isSavingWeek = false;
      let isWeekDirty = false;
      let cobrandTotalsBySeller = {};
      let cobrandDayCredits = {}; // week -> nameLower -> dayLabel -> amount
      const MS_PER_DAY = 24 * 60 * 60 * 1000;
      let christmasData = [];
      let drawTicketsRemaining = {};
      let drawHistory = [];
      let isDrawing = false;
      let payoutTiers = [];
      let payoutRules = [];
      let payoutPrizes = [];
      let payoutSummary = [];
      let payoutsLoaded = false;
      let seasons = [];
      let selectedSeasonYear = null;
      let weeklySort = { field: null, direction: 'desc' };
      let activeRosterNames = null;

      const dayKeys = ['tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday', 'monday'];
      const christmasDays = Array.from({ length: 12 }, (_, idx) => {
        const day = 13 + idx;
        return `Dec ${day}`;
      });
      const SEASONS_KEY = 'gift_tracker_seasons';
      const getSeasonYear = () => selectedSeasonYear || 2025;
      const seasonQuery = () => `season_year=${encodeURIComponent(getSeasonYear())}`;

      const setStatus = (node, message, isError = false) => {
        if (!node) return;
        if (!message) {
          node.textContent = '';
          node.classList.remove('error');
          return;
        }
        node.textContent = message;
        node.classList.toggle('error', Boolean(isError));
      };

      const loadSeasonsLocal = () => {
        try {
          const stored = localStorage.getItem(SEASONS_KEY);
          if (stored) {
            seasons = JSON.parse(stored);
          }
        } catch (err) {
          seasons = [];
        }
        if (!Array.isArray(seasons)) seasons = [];
        if (!seasons.length) {
          seasons.push({ year: 2025, start_date: '2025-11-05' });
        }
        if (!selectedSeasonYear || !seasons.some((s) => s.year === selectedSeasonYear)) {
          selectedSeasonYear = seasons[0].year;
        }
      };

      const loadSeasonsFromServer = async () => {
        try {
          const resp = await authFetch('/seasons');
          if (!resp.ok) throw new Error('server seasons not available');
          const data = await resp.json();
          if (Array.isArray(data) && data.length) {
            seasons = data;
            if (!selectedSeasonYear || !seasons.some((s) => s.year === selectedSeasonYear)) {
              selectedSeasonYear = seasons[0].year;
            }
            saveSeasons();
          } else {
            loadSeasonsLocal();
          }
        } catch (err) {
          loadSeasonsLocal();
        }
      };

      const saveSeasons = () => {
        localStorage.setItem(SEASONS_KEY, JSON.stringify(seasons));
      };

      const renderSeasonSelect = () => {
        if (!seasonSelect) return;
        seasonSelect.innerHTML = seasons
          .map((s) => `<option value="${s.year}" ${s.year === selectedSeasonYear ? 'selected' : ''}>${s.year}</option>`)
          .join('');
      };

      const addSeason = async (year, startDate) => {
        const idx = seasons.findIndex((s) => s.year === year);
        if (idx >= 0) {
          seasons[idx].start_date = startDate;
        } else {
          seasons.push({ year, start_date: startDate });
          seasons.sort((a, b) => a.year - b.year);
        }
        selectedSeasonYear = year;
        try {
          await authFetch('/seasons', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ year, start_date: startDate }),
          });
        } catch (err) {
          console.warn('Season save fallback to local only', err);
        }
        saveSeasons();
        renderSeasonSelect();
        renderWeeklyHeadLabels();
      };

      const openSeasonModal = () => {
        const { modal, close } = showFormModal('Add Season', (content) => {
          content.innerHTML = `
            <div class="form-group">
              <label>Year</label>
              <input id="season-year" type="number" min="2024" step="1" value="${new Date().getFullYear()}" />
            </div>
            <div class="form-group">
              <label>Start Date (first Tuesday)</label>
              <input id="season-start" type="date" />
            </div>
            <div style="display:flex;gap:.6rem;align-items:center;margin-top:.6rem;">
              <button class="primary-btn" type="button" id="save-season-modal">Save Season</button>
            </div>
          `;
        });
        modal.querySelector('#save-season-modal').addEventListener('click', () => {
          const yearVal = Number(modal.querySelector('#season-year').value);
          const startVal = modal.querySelector('#season-start').value;
          if (!yearVal || !startVal) {
            setStatus(statusMsg, 'Year and start date required.', true);
            return;
          }
          addSeason(yearVal, startVal).then(close);
        });
      };

      const getSelectedSeason = () => seasons.find((s) => s.year === selectedSeasonYear);

      const getDateLabelFor = (week, dayIndex) => {
        const season = getSelectedSeason();
        if (!season || !season.start_date) return '';
        const start = new Date(season.start_date);
        if (Number.isNaN(start.getTime())) return '';
        const offset = (week - 1) * 7 + dayIndex;
        const target = new Date(start.getTime() + offset * 24 * 60 * 60 * 1000);
        return `${(target.getMonth() + 1).toString().padStart(2, '0')}/${target
          .getDate()
          .toString()
          .padStart(2, '0')}`;
      };

      const renderWeeklyHeadLabels = () => {
        if (!weeklyHeadRows.length) return;
        const sortIndicator = (key) => {
          if (weeklySort.field !== key) return '';
          return weeklySort.direction === 'asc' ? ' ▲' : ' ▼';
        };
        const labels = days.map((d, idx) => {
          const dateLabel = getDateLabelFor(currentWeek, idx);
          return `${d}${dateLabel ? ` (${dateLabel})` : ''}`;
        });
        const headerHtml = `
          <th data-sort="name" class="sortable">Server${sortIndicator('name')}</th>
          ${labels.map((l, idx) => `<th data-sort="${days[idx]}" class="sortable">${l}${sortIndicator(days[idx])}</th>`).join('')}
          <th data-sort="week" class="sortable">This Week${sortIndicator('week')}</th>
          <th data-sort="ytd" class="sortable">YTD${sortIndicator('ytd')}</th>
          <th data-sort="goal" class="sortable">Goal${sortIndicator('goal')}</th>
        `;
        weeklyHeadRows.forEach((row) => {
          row.innerHTML = headerHtml;
        });
      };

      const getSeasonStartDate = () => {
        const season = getSelectedSeason();
        if (!season || !season.start_date) return null;
        const d = new Date(season.start_date);
        return Number.isNaN(d.getTime()) ? null : d;
      };

      const mapCobrandsToDaysFromDeals = (deals) => {
        cobrandDayCredits = {};
        cobrandTotalsBySeller = {};
        const startDate = getSeasonStartDate();
        if (!startDate) return;
        const startMs = new Date(startDate.getTime()).setHours(0, 0, 0, 0);
        deals.forEach((deal) => {
          if (!deal.date_of_commission || !deal.seller_name) return;
          const commission = new Date(deal.date_of_commission);
          if (Number.isNaN(commission.getTime())) return;
          const commissionMs = new Date(commission.getTime()).setHours(0, 0, 0, 0);
          const diffDays = Math.floor((commissionMs - startMs) / MS_PER_DAY);
          if (diffDays < 0) return;
          const weekIdx = Math.floor(diffDays / 7) + 1;
          const dayIdx = diffDays % 7;
          if (weekIdx < 1 || weekIdx > weeksCount) return;
          const nameKey = deal.seller_name.toLowerCase();
          cobrandTotalsBySeller[nameKey] = (cobrandTotalsBySeller[nameKey] || 0) + Number(deal.amount_usd || 0);
          if (!cobrandDayCredits[weekIdx]) cobrandDayCredits[weekIdx] = {};
          if (!cobrandDayCredits[weekIdx][nameKey]) cobrandDayCredits[weekIdx][nameKey] = {};
          const dayLabel = days[dayIdx];
          cobrandDayCredits[weekIdx][nameKey][dayLabel] =
            (cobrandDayCredits[weekIdx][nameKey][dayLabel] || 0) + Number(deal.amount_usd || 0);
        });
      };

      const markWeekDirty = (dirty) => {
        isWeekDirty = dirty;
        if (saveWeekBtn) {
          if (dirty) {
            saveWeekBtn.classList.add('pulse');
          } else {
            saveWeekBtn.classList.remove('pulse');
          }
        }
      };

      const loadCobrandTotalsForTracker = async () => {
        try {
          const resp = await authFetch(`/cobrands?${seasonQuery()}`);
          if (!resp.ok) throw new Error(`Unable to load cobrands (${resp.status})`);
          cobrandDeals = await resp.json();
          mapCobrandsToDaysFromDeals(cobrandDeals);
          renderTable();
        } catch (err) {
          console.error(err);
          setStatus(weeklyStatus, err.message || 'Unable to sync cobrands', true);
        }
      };

      const formatUsdDisplay = (value) => {
        if (!Number.isFinite(value)) return '$0.00';
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
      };

      const parseUsdValue = (value) => {
        if (!value) return null;
        const sanitized = value.replace(/[^0-9.]/g, '');
        if (!sanitized) return null;
        return Number(sanitized);
      };

      const formatDateLabel = (value) => {
        if (!value) return '—';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return '—';
        return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
      };

      const getStoredToken = () => {
        const cookieMatch = document.cookie
          .split(';')
          .map((c) => c.trim())
          .find((c) => c.startsWith('tss_access_token='));
        if (cookieMatch) return cookieMatch.split('=')[1];
        return localStorage.getItem('tss_access_token');
      };

      const authFetch = (url, options = {}) => {
        const headers = { ...(options.headers || {}) };
        const token = getStoredToken();
        if (token) headers.Authorization = `Bearer ${token}`;
        return fetch(url, { ...options, headers, credentials: 'include' });
      };

      const setStoredTokens = (access, refresh) => {
        if (access) {
          document.cookie = `tss_access_token=${access}; path=/; max-age=${COOKIE_MAX_AGE}; SameSite=Lax`;
          localStorage.setItem('tss_access_token', access);
        }
        if (refresh) {
          document.cookie = `tss_refresh_token=${refresh}; path=/; max-age=${COOKIE_MAX_AGE}; SameSite=Lax`;
          localStorage.setItem('tss_refresh_token', refresh);
        }
      };

      const authGate = document.getElementById('auth-gate');
      const authGateForm = document.getElementById('auth-gate-form');
      const authGateStatus = document.getElementById('auth-gate-status');
      const authEmailInput = document.getElementById('auth-email');
      const authPasswordInput = document.getElementById('auth-password');

      const setAuthGateStatus = (message, isError = false) => {
        if (!authGateStatus) return;
        authGateStatus.textContent = message || '';
        authGateStatus.className = `auth-status ${isError ? 'error' : 'success'}`;
      };

      const showAuthGate = (message) => {
        if (!authGate) return;
        authGate.classList.remove('hidden');
        setAuthGateStatus(message || 'Please sign in to continue.', false);
      };

      const hideAuthGate = () => {
        if (!authGate) return;
        authGate.classList.add('hidden');
        setAuthGateStatus('', false);
      };

      const loginFromGate = async (email, password) => {
        const resp = await fetch('/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email, password }),
        });
        if (!resp.ok) {
          const detail = await resp.json().catch(() => ({}));
          throw new Error(detail.detail || `HTTP ${resp.status}`);
        }
        const data = await resp.json().catch(() => ({}));
        if (data?.access_token) {
          setStoredTokens(data.access_token, data.refresh_token);
        }
      };

      const ensureAuthenticated = async () => {
        try {
          const resp = await authFetch('/auth/me');
          if (!resp.ok) throw new Error('Not authenticated');
          hideAuthGate();
          return true;
        } catch (err) {
          showAuthGate('Session missing or expired. Sign in again.');
          return false;
        }
      };

      if (authGateForm) {
        authGateForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const email = authEmailInput?.value.trim();
          const password = authPasswordInput?.value;
          if (!email || !password) return;
          try {
            setAuthGateStatus('Signing in...');
            await loginFromGate(email, password);
            const ok = await ensureAuthenticated();
            if (ok) {
              setAuthGateStatus('Signed in.', false);
              hideAuthGate();
              await initialize();
            }
          } catch (err) {
            setAuthGateStatus(err.message || 'Sign-in failed.', true);
          }
        });
      }

      const initData = (names) => {
        giftData = {};
        for (let w = 1; w <= weeksCount; w++) {
          giftData[w] = names.map((name) => {
            const entries = {};
            days.forEach((d) => {
              entries[d] = 0;
            });
            return { name, ...entries };
          });
        }
      };

      const computeYtdMap = () => {
        const ytd = {};
        for (let w = 1; w <= weeksCount; w++) {
          giftData[w].forEach((row) => {
            const weekTotal = days.reduce((sum, d) => sum + Number(row[d] || 0), 0);
            ytd[row.name] = (ytd[row.name] || 0) + weekTotal;
          });
        }
        return ytd;
      };

      const ensureWeekData = (week) => {
        if (!giftData[week]) {
          giftData[week] = [];
        }
      };

      const upsertWeekEntry = (week, entry) => {
        ensureWeekData(week);
        const lower = entry.employee_name.toLowerCase();
        let row = giftData[week].find((r) => r.name.toLowerCase() === lower);
        if (!row) {
          row = { name: entry.employee_name };
          days.forEach((d) => {
            row[d] = 0;
          });
          giftData[week].push(row);
        }
        days.forEach((d) => {
          const key = d.toLowerCase();
          const val = entry[key];
          row[d] = (val !== undefined && val !== null && !Number.isNaN(Number(val))) ? Number(val) : 0;
        });
      };

      const initChristmasData = (names) => {
        christmasData = names.map((name) => {
          const entry = { name };
          christmasDays.forEach((d) => {
            entry[d] = 0;
          });
          entry.total = 0;
          entry.tickets = 0;
          return entry;
        });
      };

      const computeChristmasTickets = () => {
        // reset totals
        christmasData.forEach((entry) => {
          entry.total = 0;
          entry.tickets = 0;
        });
        christmasDays.forEach((dayLabel) => {
          const dayValues = christmasData.map((entry) => ({
            name: entry.name,
            value: Number(entry[dayLabel] || 0),
          }));
          dayValues.sort((a, b) => b.value - a.value);
          const awards = [5, 3, 1, 1, 1];
          dayValues.slice(0, awards.length).forEach((item, idx) => {
            const points = awards[idx];
            const target = christmasData.find((e) => e.name === item.name);
            if (!target) return;
            target.tickets += points;
          });
        });
        christmasData.forEach((entry) => {
          entry.total = christmasDays.reduce((sum, d) => sum + Number(entry[d] || 0), 0);
        });
        resetDrawPool();
      };

      const loadServerRoster = async () => {
        const resp = await authFetch('/employees?role=SERVER&active=true');
        if (resp.status === 401) throw new Error('Unauthorized. Log in again to load servers.');
        if (!resp.ok) throw new Error(`Roster fetch failed (${resp.status})`);
        const data = await resp.json();
        if (!Array.isArray(data) || !data.length) throw new Error('Empty roster');
        return data.map((emp) => `${emp.first_name} ${emp.last_name}`.trim());
      };

      const normalizeName = (value) => (value || '').trim().toLowerCase();

      const loadDailyRoster = async () => {
        if (!rosterDateInput) return;
        const dateVal = rosterDateInput.value;
        if (!dateVal) {
          activeRosterNames = null;
          setStatus(rosterStatus, 'Select a roster date.');
          renderTable();
          return;
        }
        const params = new URLSearchParams();
        params.append('date', dateVal);
        const storeVal = rosterStoreInput?.value;
        if (storeVal) params.append('store_id', storeVal);
        setStatus(rosterStatus, 'Loading roster...');
        try {
          const resp = await authFetch(`/daily-rosters?${params.toString()}`);
          if (resp.status === 401) throw new Error('Unauthorized. Log in again.');
          if (!resp.ok) throw new Error(`Roster fetch failed (${resp.status})`);
          const data = await resp.json();
          if (!Array.isArray(data) || !data.length) {
            activeRosterNames = null;
            setStatus(rosterStatus, 'No roster found for that date.');
            renderTable();
            return;
          }
          const roster = data[0];
          const entries = Array.isArray(roster.entries) ? roster.entries : [];
          activeRosterNames = new Set(entries.map((entry) => normalizeName(entry.name)));
          setStatus(rosterStatus, `Loaded ${activeRosterNames.size} rostered server${activeRosterNames.size === 1 ? '' : 's'}.`);
        } catch (err) {
          console.error(err);
          activeRosterNames = null;
          setStatus(rosterStatus, err.message || 'Unable to load roster.', true);
        }
        renderTable();
      };


      const renderTabs = () => {
        tabsEl.innerHTML = '';
        for (let w = 1; w <= weeksCount; w++) {
          const btn = document.createElement('button');
          btn.className = 'tab' + (w === currentWeek ? ' active' : '');
          btn.textContent = `Week ${w}`;
          btn.addEventListener('click', () => {
            currentWeek = w;
            renderTabs();
            renderWeeklyHeadLabels();
            renderTable();
          });
          tabsEl.appendChild(btn);
        }
      };

      const loadGiftTrackerData = async () => {
        setStatus(weeklyStatus, 'Loading weekly tracker data...');
        try {
        const resp = await authFetch(`/gift-tracker?${seasonQuery()}`);
          if (!resp.ok) throw new Error(`Unable to load tracker data (${resp.status})`);
          const entries = await resp.json();
          entries.forEach((entry) => {
            const weekNum = Number(entry.week_number);
            if (!Number.isFinite(weekNum) || weekNum < 1 || weekNum > weeksCount) return;
            upsertWeekEntry(weekNum, entry);
          });
          giftTrackerLoaded = true;
          setStatus(
            weeklyStatus,
            `Synced ${entries.length} tracker entr${entries.length === 1 ? 'y' : 'ies'}.`,
          );
          markWeekDirty(false);
          renderTable();
        } catch (err) {
          console.error(err);
          setStatus(weeklyStatus, err.message || 'Unable to load weekly tracker data', true);
        }
      };

      const saveCurrentWeek = async () => {
        if (!isAdmin) {
          setStatus(weeklyStatus, 'You need edit access to save.', true);
          return;
        }
        const rows = giftData[currentWeek] || [];
        const entries = rows.map((row) => {
          const payload = { employee_name: row.name };
          days.forEach((d) => {
            payload[d.toLowerCase()] = Number(row[d] || 0);
          });
          return payload;
        });
        const body = {
          week_number: currentWeek,
          season_year: getSeasonYear(),
          entries,
        };
        setStatus(weeklyStatus, 'Saving week...');
        isSavingWeek = true;
        if (saveWeekBtn) saveWeekBtn.disabled = true;
        try {
          const resp = await authFetch(`/gift-tracker?${seasonQuery()}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(body),
          });
          if (!resp.ok) throw new Error(`Unable to save week (${resp.status})`);
          const saved = await resp.json();
          saved.forEach((entry) => {
            upsertWeekEntry(currentWeek, entry);
          });
          markWeekDirty(false);
          setStatus(weeklyStatus, 'Week saved to server.');
          renderTable();
        } catch (err) {
          console.error(err);
          setStatus(weeklyStatus, err.message || 'Unable to save week', true);
        } finally {
          isSavingWeek = false;
          if (saveWeekBtn) saveWeekBtn.disabled = !isAdmin;
        }
      };

      const renderTable = () => {
        const ytdMap = computeYtdMap();
        const rows = (giftData[currentWeek] || []).map((row, rowIndex) => {
          const nameKey = row.name.toLowerCase();
          const dailyBonuses = cobrandDayCredits[currentWeek]?.[nameKey] || {};
          const weekTotal = days.reduce((sum, d) => sum + Number(row[d] || 0) + Number(dailyBonuses[d] || 0), 0);
          const cobrandBonus = cobrandTotalsBySeller[nameKey] || 0;
          const ytd = (ytdMap[row.name] || 0) + cobrandBonus;
          const goal = UNIVERSAL_GOAL - ytd;
          return { row, rowIndex, nameKey, dailyBonuses, weekTotal, ytd, goal };
        });

        const getSortValue = (entry, field) => {
          if (field === 'name') return entry.row.name.toLowerCase();
          if (field === 'week') return entry.weekTotal;
          if (field === 'ytd') return entry.ytd;
          if (field === 'goal') return entry.goal;
          const dayIdx = days.findIndex((d) => d.toLowerCase() === field.toLowerCase());
          if (dayIdx >= 0) {
            const dayLabel = days[dayIdx];
            return Number(entry.row[dayLabel] || 0) + Number(entry.dailyBonuses[dayLabel] || 0);
          }
          return 0;
        };

        if (weeklySort.field) {
          const dir = weeklySort.direction === 'asc' ? 1 : -1;
          rows.sort((a, b) => {
            const aVal = getSortValue(a, weeklySort.field);
            const bVal = getSortValue(b, weeklySort.field);
            if (typeof aVal === 'string' || typeof bVal === 'string') {
              return aVal.localeCompare(bVal) * dir;
            }
            if (aVal === bVal) return a.row.name.localeCompare(b.row.name);
            return (aVal - bVal) * dir;
          });
        }

        if (!activeTbody) return;
        const totalColumns = days.length + 4;
        const renderEmpty = (target, message) => {
          if (!target) return;
          target.innerHTML = `<tr><td colspan="${totalColumns}" style="text-align:center;color:#8ea0d6;">${message}</td></tr>`;
        };
        const buildRow = (entry) => {
          const { row, rowIndex, dailyBonuses, weekTotal, ytd, goal } = entry;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="text-align:left;font-weight:600;">${row.name}</td>
            ${days
              .map((d) => {
                const val = row[d] ?? 0;
                const cb = dailyBonuses[d] || 0;
                const displayVal = val + cb;
                if (isAdmin) {
                  return `<td><input type="number" min="0" step="1" data-row="${rowIndex}" data-day="${d}" value="${val}">${cb ? `<div style="font-size:.8rem;color:#9bb0ff;">+${cb} cb</div>` : ''}</td>`;
                }
                return `<td>${displayVal}${cb ? ` <span style="color:#9bb0ff;font-size:.85rem;">(+${cb} cb)</span>` : ''}</td>`;
              })
              .join('')}
            <td>${weekTotal}</td>
            <td>${ytd}</td>
            <td>${goal}</td>
          `;
          return tr;
        };

        const activeRows = [];
        const inactiveRows = [];
        if (activeRosterNames && activeRosterNames.size) {
          rows.forEach((entry) => {
            if (activeRosterNames.has(entry.nameKey)) {
              activeRows.push(entry);
            } else {
              inactiveRows.push(entry);
            }
          });
        } else {
          activeRows.push(...rows);
        }

        activeTbody.innerHTML = '';
        if (activeRows.length) {
          activeRows.forEach((entry) => {
            activeTbody.appendChild(buildRow(entry));
          });
        } else {
          renderEmpty(activeTbody, 'No servers match the active roster.');
        }

        if (inactiveRosterSection && inactiveTbody) {
          if (activeRosterNames && activeRosterNames.size) {
            inactiveRosterSection.classList.remove('hidden');
            inactiveTbody.innerHTML = '';
            if (inactiveRows.length) {
              inactiveRows.forEach((entry) => {
                inactiveTbody.appendChild(buildRow(entry));
              });
            } else {
              renderEmpty(inactiveTbody, 'No other servers outside the roster.');
            }
          } else {
            inactiveRosterSection.classList.add('hidden');
            inactiveTbody.innerHTML = '';
          }
        }

        if (isAdmin) {
          document.querySelectorAll('#table-body-active input, #table-body-inactive input').forEach((input) => {
            input.addEventListener('change', (e) => {
              const rowIdx = Number(e.target.dataset.row);
              const day = e.target.dataset.day;
              const val = Number(e.target.value || 0);
              giftData[currentWeek][rowIdx][day] = val;
              markWeekDirty(true);
              renderTable();
            });
          });
        }
      };

      const renderChristmasHead = () => {
        if (!christmasHeadRow) return;
        christmasHeadRow.innerHTML = '<th>Employee</th>';
        christmasDays.forEach((label) => {
          const th = document.createElement('th');
          th.textContent = label;
          christmasHeadRow.appendChild(th);
        });
        const totalTh = document.createElement('th');
        totalTh.textContent = 'Total';
        christmasHeadRow.appendChild(totalTh);
        const ticketTh = document.createElement('th');
        ticketTh.textContent = 'Tickets';
        christmasHeadRow.appendChild(ticketTh);
      };

      const renderChristmasTable = () => {
        if (!christmasBody) return;
        if (!christmasData.length) {
          christmasBody.innerHTML = '<tr><td colspan="15" style="text-align:center;color:#8ea0d6;">No roster loaded.</td></tr>';
          return;
        }
        computeChristmasTickets();
        christmasBody.innerHTML = christmasData
          .map((entry, rowIdx) => {
            const cells = christmasDays
              .map((label) => {
                const val = entry[label] ?? 0;
                if (isAdmin) {
                  return `<td><input type="number" min="0" step="1" data-c-row="${rowIdx}" data-c-day="${label}" value="${val}"></td>`;
                }
                return `<td>${val}</td>`;
              })
              .join('');
            return `
              <tr>
                <td style="text-align:left;font-weight:600;">${entry.name}</td>
                ${cells}
                <td>${entry.total}</td>
                <td>${entry.tickets}</td>
              </tr>
            `;
          })
          .join('');

        if (isAdmin) {
          christmasBody.querySelectorAll('input').forEach((input) => {
            input.addEventListener('change', (e) => {
              const rowIdx = Number(e.target.dataset.cRow);
              const dayLabel = e.target.dataset.cDay;
              const val = Number(e.target.value || 0);
              if (christmasData[rowIdx]) {
                christmasData[rowIdx][dayLabel] = val;
                renderChristmasTable();
              }
            });
          });
        }
      };

      const resetDrawPool = () => {
        drawTicketsRemaining = {};
        christmasData.forEach((entry) => {
          drawTicketsRemaining[entry.name] = entry.tickets || 0;
        });
        updateDrawCounts();
      };

      const buildTicketPool = () => {
        const pool = [];
        Object.entries(drawTicketsRemaining).forEach(([name, count]) => {
          for (let i = 0; i < count; i++) pool.push(name);
        });
        return pool;
      };

      const updateDrawHistoryUI = () => {
        if (!drawHistoryList) return;
        if (!drawHistory.length) {
          drawHistoryList.innerHTML = '<li style="color:#8ea0d6;">No draws yet.</li>';
          return;
        }
        drawHistoryList.innerHTML = drawHistory
          .map(
            (item, idx) => `
              <li>
                <span>#${idx + 1} - ${item.name}</span>
                <span class="tag-sm">${item.timestamp}</span>
              </li>
            `,
          )
          .join('');
      };

      const updateDrawCounts = () => {
        const remainingTickets = Object.values(drawTicketsRemaining).reduce((a, b) => a + b, 0);
        const giftsLeft = Math.max(0, 12 - drawHistory.length);
        if (drawsRemaining) {
          drawsRemaining.textContent = `${giftsLeft} gift${giftsLeft === 1 ? '' : 's'} left • ${remainingTickets} tickets`;
        }
        if (drawBtn) drawBtn.disabled = isDrawing || !remainingTickets || drawHistory.length >= 12;
      };

      const showDrawOverlay = (name, ticketsBefore) => {
        const overlay = document.createElement('div');
        overlay.className = 'overlay visible';
        const modal = document.createElement('div');
        modal.className = 'draw-modal';
        modal.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <strong>Drawing...</strong>
            <button class="ghost-btn" type="button" id="close-draw-modal">Close</button>
          </div>
          <div class="draw-roller">
            <div class="draw-list" id="draw-list"></div>
          </div>
          <div class="winner-highlight" id="winner-highlight">Selecting...</div>
          <div style="color:#9bb0ff;font-size:.9rem;">Tickets before draw: ${ticketsBefore}</div>
          <div style="margin-top:.8rem;display:flex;gap:.6rem;">
            <button class="primary-btn" type="button" id="draw-again-btn">Draw Again</button>
            <button class="ghost-btn" type="button" id="close-draw-modal-2">Close</button>
          </div>
        `;
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        return overlay;
      };

      const performDraw = () => {
        if (isDrawing) return;
        const pool = buildTicketPool();
        if (!pool.length) {
          setStatus(drawStatus, 'No tickets available to draw.', true);
          return;
        }
        if (drawHistory.length >= 12) {
          setStatus(drawStatus, 'All 12 gifts have been drawn.', true);
          return;
        }
        isDrawing = true;
        setStatus(drawStatus, 'Drawing...');
        const ticketsBefore = pool.length;
        const winner = pool[Math.floor(Math.random() * pool.length)];

        // Prepare animation list
        const spinList = [];
        for (let i = 0; i < 18; i++) {
          spinList.push(pool[Math.floor(Math.random() * pool.length)]);
        }
        spinList.push(winner);

        const overlay = showDrawOverlay(winner, ticketsBefore);
        const listEl = overlay.querySelector('#draw-list');
        const winnerEl = overlay.querySelector('#winner-highlight');
        listEl.innerHTML = spinList.map((n) => `<div class="name">${n}</div>`).join('');
        const itemHeight = 24;
        requestAnimationFrame(() => {
          listEl.style.transform = `translateY(-${(spinList.length - 1) * itemHeight}px)`;
        });
        setTimeout(() => {
          winnerEl.textContent = `Winner: ${winner}!`;
          setStatus(drawStatus, `Winner: ${winner}`);
          // decrement ticket
          if (drawTicketsRemaining[winner] > 0) {
            drawTicketsRemaining[winner] -= 1;
          }
          drawHistory.push({
            name: winner,
            timestamp: new Date().toLocaleTimeString(),
          });
          updateDrawHistoryUI();
          updateDrawCounts();
          isDrawing = false;
        }, 1700);

        const closeModal = () => {
          overlay.remove();
        };
        overlay.querySelector('#close-draw-modal').addEventListener('click', closeModal);
        overlay.querySelector('#close-draw-modal-2').addEventListener('click', closeModal);
        overlay.querySelector('#draw-again-btn').addEventListener('click', () => {
          closeModal();
          performDraw();
        });
      };

      const resetDraws = () => {
        drawHistory = [];
        resetDrawPool();
        updateDrawHistoryUI();
        setStatus(drawStatus, 'Draws reset.');
      };

      const viewResults = () => {
        const overlay = document.createElement('div');
        overlay.className = 'overlay visible';
        const modal = document.createElement('div');
        modal.className = 'draw-modal';
        const items = drawHistory
          .map((item, idx) => `<li>#${idx + 1}: ${item.name} <span class="tag-sm">${item.timestamp}</span></li>`)
          .join('') || '<li style="color:#8ea0d6;">No draws yet.</li>';
        modal.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <strong>Results</strong>
            <button class="ghost-btn" type="button" id="close-results">Close</button>
          </div>
          <ul style="list-style:none;padding:0;margin:.8rem 0;display:flex;flex-direction:column;gap:.35rem;">${items}</ul>
        `;
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        overlay.querySelector('#close-results').addEventListener('click', () => overlay.remove());
      };

      const showFormModal = (title, contentNodeBuilder) => {
        const overlay = document.createElement('div');
        overlay.className = 'overlay visible';
        const modal = document.createElement('div');
        modal.className = 'form-modal';
        modal.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem;">
            <h3 style="margin:0;">${title}</h3>
            <button class="ghost-btn" type="button" id="close-form-modal">Close</button>
          </div>
        `;
        const content = document.createElement('div');
        contentNodeBuilder(content);
        modal.appendChild(content);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        const close = () => overlay.remove();
        modal.querySelector('#close-form-modal').addEventListener('click', close);
        return { overlay, modal, close };
      };

      const openTierModal = () => {
        const { modal, close } = showFormModal('Add Tier', (content) => {
          content.innerHTML = `
            <div class="form-group">
              <label>Label</label>
              <input id="tier-label" type="text" placeholder="e.g., Bronze" />
            </div>
            <div class="form-group">
              <label>Min Amount ($)</label>
              <input id="tier-min" type="number" min="0" step="0.01" />
            </div>
            <div class="form-group">
              <label>Max Amount ($, optional)</label>
              <input id="tier-max" type="number" min="0" step="0.01" />
            </div>
            <div class="form-group">
              <label>Payout Type</label>
              <select id="tier-type">
                <option value="FIXED">Fixed $</option>
                <option value="PERCENT">Percent</option>
              </select>
            </div>
            <div class="form-group">
              <label>Payout Value</label>
              <input id="tier-value" type="number" min="0" step="0.01" placeholder="Dollars or percent" />
            </div>
            <div style="display:flex;gap:.6rem;align-items:center;margin-top:.6rem;">
              <button class="primary-btn" type="button" id="save-tier-modal">Save Tier</button>
            </div>
          `;
        });
        const saveBtn = modal.querySelector('#save-tier-modal');
        saveBtn.addEventListener('click', async () => {
          const label = modal.querySelector('#tier-label').value.trim();
          if (!label) return setStatus(payoutsStatus, 'Label required.', true);
          const min = Number(modal.querySelector('#tier-min').value || 0);
          const maxVal = modal.querySelector('#tier-max').value;
          const max = maxVal ? Number(maxVal) : null;
          const type = modal.querySelector('#tier-type').value === 'PERCENT' ? 'PERCENT' : 'FIXED';
          const val = Number(modal.querySelector('#tier-value').value || 0);
          const payload = {
            label,
            min_amount_cents: Math.round(min * 100),
            max_amount_cents: max != null ? Math.round(max * 100) : null,
            payout_type: type,
            payout_value: type === 'PERCENT' ? Math.round(val * 100) : Math.round(val * 100),
            season_year: getSeasonYear(),
            active: true,
          };
          const resp = await authFetch('/payouts/tiers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) {
            setStatus(payoutsStatus, `Could not add tier (${resp.status})`, true);
            return;
          }
          await loadTiers();
          setStatus(payoutsStatus, 'Tier added.');
          close();
        });
      };

      const openRuleModal = () => {
        const { modal, close } = showFormModal('Add Rule (Top Seller)', (content) => {
          content.innerHTML = `
            <div class="form-group">
              <label>Rule Name</label>
              <input id="rule-name" type="text" value="Season top seller" />
            </div>
            <div class="form-group">
              <label>First place percent</label>
              <input id="rule-first" type="number" min="0" step="0.01" value="10" />
            </div>
            <div class="form-group">
              <label>Second place percent</label>
              <input id="rule-second" type="number" min="0" step="0.01" value="5" />
            </div>
            <div style="display:flex;gap:.6rem;align-items:center;margin-top:.6rem;">
              <button class="primary-btn" type="button" id="save-rule-modal">Save Rule</button>
            </div>
          `;
        });
        modal.querySelector('#save-rule-modal').addEventListener('click', async () => {
          const name = modal.querySelector('#rule-name').value.trim() || 'Season top seller';
          const firstPct = Number(modal.querySelector('#rule-first').value || 10);
          const secondPct = Number(modal.querySelector('#rule-second').value || 5);
          const payload = {
            name,
            type: 'season_top_seller',
            config: { first_pct: firstPct, second_pct: secondPct },
            season_year: getSeasonYear(),
            active: true,
          };
          const resp = await authFetch('/payouts/rules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) {
            setStatus(payoutsStatus, `Could not add rule (${resp.status})`, true);
            return;
          }
          await loadRules();
          setStatus(payoutsStatus, 'Rule added.');
          close();
        });
      };

      const openPrizeModal = () => {
        const { modal, close } = showFormModal('Add Prize', (content) => {
          content.innerHTML = `
            <div class="form-group">
              <label>Prize Name</label>
              <input id="prize-name" type="text" placeholder="Prize name" />
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea id="prize-desc" rows="2" placeholder="Optional description"></textarea>
            </div>
            <div class="form-group">
              <label>Cost ($, optional)</label>
              <input id="prize-cost" type="number" min="0" step="0.01" />
            </div>
            <div class="form-group">
              <label>Image URL (optional)</label>
              <input id="prize-image" type="text" placeholder="https://..." />
            </div>
            <div style="display:flex;gap:.6rem;align-items:center;margin-top:.6rem;">
              <button class="primary-btn" type="button" id="save-prize-modal">Save Prize</button>
            </div>
          `;
        });
        modal.querySelector('#save-prize-modal').addEventListener('click', async () => {
          const name = modal.querySelector('#prize-name').value.trim();
          if (!name) return setStatus(payoutsStatus, 'Prize name required.', true);
          const desc = modal.querySelector('#prize-desc').value.trim();
          const costVal = modal.querySelector('#prize-cost').value;
          const image = modal.querySelector('#prize-image').value.trim() || null;
          const payload = {
            name,
            description: desc,
            cost_cents: costVal ? Math.round(Number(costVal) * 100) : null,
            image_url: image,
            season_year: getSeasonYear(),
            active: true,
          };
          const resp = await authFetch('/payouts/prizes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) {
            setStatus(payoutsStatus, `Could not add prize (${resp.status})`, true);
            return;
          }
          await loadPrizes();
          setStatus(payoutsStatus, 'Prize added.');
          close();
        });
      };

      const renderTierList = () => {
        if (!tierList) return;
        if (!payoutTiers.length) {
          tierList.innerHTML = '<li style="color:#8ea0d6;">No tiers yet.</li>';
          return;
        }
        tierList.innerHTML = payoutTiers
          .map(
            (t) =>
              `<li style="display:flex;justify-content:space-between;gap:.6rem;align-items:center;">
                <span>${t.label}: $${(t.min_amount_cents / 100).toFixed(2)} - ${t.max_amount_cents ? '$' + (t.max_amount_cents / 100).toFixed(2) : '∞'} → ${t.payout_type === 'PERCENT' ? (t.payout_value / 100).toFixed(2) + '%': '$' + (t.payout_value / 100).toFixed(2)} ${!t.active ? '(inactive)' : ''}</span>
                <button class="ghost-btn" type="button" data-del-tier="${t.id}">Delete</button>
              </li>`,
          )
          .join('');
        tierList.querySelectorAll('button[data-del-tier]').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-del-tier');
            await deleteTier(id);
          });
        });
      };

      const renderRuleList = () => {
        if (!ruleList) return;
        if (!payoutRules.length) {
          ruleList.innerHTML = '<li style="color:#8ea0d6;">No rules yet.</li>';
          return;
        }
        ruleList.innerHTML = payoutRules
          .map(
            (r) => `<li style="display:flex;justify-content:space-between;gap:.6rem;align-items:center;">
              <span>${r.name} (${r.type}) ${!r.active ? '(inactive)' : ''}</span>
              <button class="ghost-btn" type="button" data-del-rule="${r.id}">Delete</button>
            </li>`,
          )
          .join('');
        ruleList.querySelectorAll('button[data-del-rule]').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-del-rule');
            await deleteRule(id);
          });
        });
      };

      const renderPrizeList = () => {
        if (!prizeList) return;
        if (!payoutPrizes.length) {
          prizeList.innerHTML = '<li style="color:#8ea0d6;">No prizes yet.</li>';
          return;
        }
        prizeList.innerHTML = payoutPrizes
          .map(
            (p) =>
              `<li style="display:flex;justify-content:space-between;gap:.6rem;align-items:center;">
                <span>${p.name} ${p.cost_cents != null ? `($${(p.cost_cents / 100).toFixed(2)})` : ''} ${p.image_url ? '📷' : ''} ${!p.active ? '(inactive)' : ''}</span>
                <button class="ghost-btn" type="button" data-del-prize="${p.id}">Delete</button>
              </li>`,
          )
          .join('');
        prizeList.querySelectorAll('button[data-del-prize]').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-del-prize');
            await deletePrize(id);
          });
        });
      };

      const renderPayoutSummary = () => {
        if (!payoutsBody) return;
        if (!payoutSummary.length) {
          payoutsBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#8ea0d6;">No payout data loaded.</td></tr>';
          return;
        }
        payoutsBody.innerHTML = payoutSummary
          .map((row) => {
            const prizeNames = (row.prizes || []).map((p) => p.name).join(', ') || '—';
            return `
              <tr>
                <td style="text-align:left;font-weight:600;">${row.employee_name}</td>
                <td>$${(row.tier_payout_cents / 100).toFixed(2)}</td>
                <td>$${(row.rule_payout_cents / 100).toFixed(2)}</td>
                <td>$${(row.misc_cents / 100).toFixed(2)}</td>
                <td>${prizeNames}</td>
                <td>$${(row.total_payout_cents / 100).toFixed(2)}</td>
                <td><button class="ghost-btn" data-add-prize="${row.employee_name}">Add prize</button></td>
              </tr>
            `;
          })
          .join('');
        payoutsBody.querySelectorAll('button[data-add-prize]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const name = btn.getAttribute('data-add-prize');
            handleAssignPrize(name);
          });
        });
      };

      const loadTiers = async () => {
        const resp = await authFetch(`/payouts/tiers?${seasonQuery()}`);
        if (resp.ok) {
          payoutTiers = await resp.json();
          renderTierList();
        }
      };

      const deleteTier = async (id) => {
        if (!window.confirm('Delete this tier?')) return;
        const resp = await authFetch(`/payouts/tiers/${id}`, {
          method: 'DELETE',
        });
        if (!resp.ok) {
          setStatus(payoutsStatus, `Could not delete tier (${resp.status})`, true);
          return;
        }
        await loadTiers();
        setStatus(payoutsStatus, 'Tier deleted.');
      };

      const loadRules = async () => {
        const resp = await authFetch(`/payouts/rules?${seasonQuery()}`);
        if (resp.ok) {
          payoutRules = await resp.json();
          renderRuleList();
        }
      };

      const deleteRule = async (id) => {
        if (!window.confirm('Delete this rule?')) return;
        const resp = await authFetch(`/payouts/rules/${id}`, {
          method: 'DELETE',
        });
        if (!resp.ok) {
          setStatus(payoutsStatus, `Could not delete rule (${resp.status})`, true);
          return;
        }
        await loadRules();
        setStatus(payoutsStatus, 'Rule deleted.');
      };

      const loadPrizes = async () => {
        const resp = await authFetch(`/payouts/prizes?${seasonQuery()}`);
        if (resp.ok) {
          payoutPrizes = await resp.json();
          renderPrizeList();
        }
      };

      const deletePrize = async (id) => {
        if (!window.confirm('Delete this prize?')) return;
        const resp = await authFetch(`/payouts/prizes/${id}`, {
          method: 'DELETE',
        });
        if (!resp.ok) {
          setStatus(payoutsStatus, `Could not delete prize (${resp.status})`, true);
          return;
        }
        await loadPrizes();
        setStatus(payoutsStatus, 'Prize deleted.');
      };

      const loadPayoutSummary = async () => {
        setStatus(payoutsStatus, 'Loading payouts...');
        try {
          const resp = await authFetch(`/payouts/summary?${seasonQuery()}`);
          if (!resp.ok) throw new Error(`Unable to load payouts (${resp.status})`);
          const data = await resp.json();
          payoutSummary = data.rows || [];
          renderPayoutSummary();
          setStatus(payoutsStatus, `Loaded ${payoutSummary.length} rows.`);
          payoutsLoaded = true;
        } catch (err) {
          console.error(err);
          setStatus(payoutsStatus, err.message || 'Unable to load payouts', true);
        }
      };

      const handleAssignPrize = async (employeeName) => {
        if (!payoutPrizes.length) {
          setStatus(payoutsStatus, 'Add prizes first.', true);
          return;
        }
        const { modal, close } = showFormModal(`Assign prize to ${employeeName}`, (content) => {
          const list = payoutPrizes
            .map(
              (p, idx) => `
                <label style="display:flex;align-items:center;gap:.7rem;padding:.4rem .2rem;cursor:pointer;">
                  <input type="radio" name="assign-prize" value="${p.id}" ${idx === 0 ? 'checked' : ''}/>
                  ${
                    p.image_url
                      ? `<img src="${p.image_url}" alt="${p.name}" style="width:42px;height:42px;border-radius:10px;object-fit:cover;border:1px solid #1f2f54;">`
                      : '<div style="width:42px;height:42px;border-radius:10px;border:1px dashed #2a3c70;display:flex;align-items:center;justify-content:center;color:#6e7ca8;">No Img</div>'
                  }
                  <span>${p.name} ${p.cost_cents != null ? `($${(p.cost_cents / 100).toFixed(2)})` : ''}</span>
                </label>
              `,
            )
            .join('');
          content.innerHTML = `
            <div class="form-group">
              <label>Select prize</label>
              <div style="display:flex;flex-direction:column;gap:.35rem;max-height:240px;overflow:auto;">${list}</div>
            </div>
            <div style="display:flex;gap:.6rem;align-items:center;margin-top:.6rem;">
              <button class="primary-btn" type="button" id="save-assign-prize">Assign</button>
            </div>
          `;
        });
        modal.querySelector('#save-assign-prize').addEventListener('click', async () => {
          const selected = modal.querySelector('input[name="assign-prize"]:checked');
          if (!selected) return;
          const prizeId = Number(selected.value);
          const payload = { employee_name: employeeName, prize_id: prizeId, notes: '', season_year: getSeasonYear() };
          const resp = await authFetch('/payouts/prizes/assign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) {
            setStatus(payoutsStatus, `Could not assign prize (${resp.status})`, true);
            return;
          }
          setStatus(payoutsStatus, `Assigned prize to ${employeeName}.`);
          close();
          await loadPayoutSummary();
        });
      };

      const determineRole = async () => {
        try {
          const resp = await authFetch('/auth/me');
          if (!resp.ok) throw new Error('Not authenticated');
          const me = await resp.json();
          isAdmin = me.role === 'ADMIN' || me.role === 'MANAGER';
          modePill.textContent = isAdmin ? 'Edit mode (Admin/Manager)' : 'View only';
          modeSubtitle.textContent = isAdmin
            ? 'You can edit daily amounts. Save to sync with the server.'
            : 'View-only mode. Contact an admin to update values.';
          if (saveWeekBtn) saveWeekBtn.disabled = !isAdmin;
        } catch (err) {
          isAdmin = false;
          modePill.textContent = 'View only';
          modeSubtitle.textContent = 'View-only mode. Sign in as an admin to edit.';
          if (saveWeekBtn) saveWeekBtn.disabled = true;
        }
      };

      const toggleView = (view) => {
        if (!viewTabsWrapper) return;
        viewTabsWrapper.querySelectorAll('.view-tab').forEach((tab) => {
          tab.classList.toggle('active', tab.dataset.view === view);
        });
        if (weeklyView) weeklyView.classList.toggle('hidden', view !== 'weekly');
        if (cobrandsView) cobrandsView.classList.toggle('hidden', view !== 'cobrands');
        if (christmasView) christmasView.classList.toggle('hidden', view !== 'christmas');
        if (payoutsView) payoutsView.classList.toggle('hidden', view !== 'payouts');
        if (view === 'cobrands' && !cobrandsLoaded) {
          loadCobrandDeals();
        }
        if (view === 'christmas') {
          renderChristmasHead();
          renderChristmasTable();
        }
        if (view === 'payouts' && !payoutsLoaded) {
          renderTierList();
          renderRuleList();
          renderPrizeList();
          loadTiers();
          loadRules();
          loadPrizes();
          loadPayoutSummary();
        }
      };

      const updateSortIndicators = () => {
        if (!cobrandTableHead) return;
        cobrandTableHead.querySelectorAll('th[data-sort]').forEach((th) => {
          const active = th.dataset.sort === cobrandSort.field;
          th.classList.toggle('sorted', active);
          th.dataset.direction = active ? (cobrandSort.direction === 'desc' ? '▼' : '▲') : '';
        });
      };

      const renderCobrandDeals = () => {
        if (!cobrandTableBody) return;
        if (!cobrandDeals.length) {
          cobrandTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#8ea0d6;">No cobrand deals have been logged.</td></tr>';
          return;
        }
        cobrandTotalsBySeller = {};
        cobrandTableBody.innerHTML = cobrandDeals
          .map((deal) => {
            const logoCell = deal.logo_base64
              ? `<img src="${deal.logo_base64}" alt="${deal.company_name} logo" style="width:48px;height:48px;border-radius:12px;object-fit:contain;background:#050b16;border:1px solid #1f2f54;">`
              : '—';
            return `
              <tr>
                <td style="text-align:left;">${deal.company_name}</td>
                <td>${formatUsdDisplay(Number(deal.amount_usd))}</td>
                <td>${formatDateLabel(deal.date_of_commission)}</td>
                <td>${formatDateLabel(deal.date_of_payment)}</td>
                <td>${formatDateLabel(deal.date_of_pickup)}</td>
                <td>${deal.seller_name || '—'}</td>
                <td>${logoCell}</td>
                <td>${formatDateLabel(deal.created_at)}</td>
              </tr>
            `;
          })
          .join('');
        mapCobrandsToDaysFromDeals(cobrandDeals);
        renderTable();
      };

      const loadCobrandDeals = async () => {
        setStatus(cobrandStatus, 'Loading deals...');
        try {
          const resp = await authFetch(
            `/cobrands?sort_by=${cobrandSort.field}&sort_dir=${cobrandSort.direction}&${seasonQuery()}`,
          );
          if (!resp.ok) throw new Error(`Unable to load deals (${resp.status})`);
          cobrandDeals = await resp.json();
          setStatus(
            cobrandStatus,
            `Loaded ${cobrandDeals.length} deal${cobrandDeals.length === 1 ? '' : 's'}.`,
          );
          renderCobrandDeals();
          cobrandsLoaded = true;
        } catch (err) {
          console.error(err);
          setStatus(cobrandStatus, err.message || 'Unable to load deals', true);
        }
        updateSortIndicators();
      };

      const renderSellerSuggestions = (options) => {
        if (!sellerSuggestions) return;
        if (!options.length) {
          sellerSuggestions.innerHTML = '<li class="muted">No matches</li>';
        } else {
          sellerSuggestions.innerHTML = options
            .map(
              (opt) => `
                <li data-id="${opt.id}" data-value="${opt.name}">
                  <span>${opt.name}</span>
                  <span class="tag">${opt.role}</span>
                </li>
              `,
            )
            .join('');
        }
        sellerSuggestions.classList.remove('hidden');
      };

      const fetchSellerSuggestions = async (term) => {
        if (!sellerSuggestions) return;
        if (sellerSearchAbort) sellerSearchAbort.abort();
        sellerSearchAbort = new AbortController();
        try {
          const resp = await authFetch(`/cobrands/sellers?search=${encodeURIComponent(term)}`, {
            signal: sellerSearchAbort.signal,
          });
          if (!resp.ok) throw new Error('Unable to fetch sellers');
          const results = await resp.json();
          renderSellerSuggestions(results);
        } catch (err) {
          if (err.name === 'AbortError') return;
          console.error(err);
          sellerSuggestions.classList.add('hidden');
        }
      };

      const compressLogo = (file) =>
        new Promise((resolve, reject) => {
          if (!file.type.startsWith('image/')) {
            reject(new Error('Please choose an image file.'));
            return;
          }
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              canvas.width = 128;
              canvas.height = 128;
              const ctx = canvas.getContext('2d');
              ctx.clearRect(0, 0, 128, 128);
              const scale = Math.min(128 / img.width, 128 / img.height);
              const drawWidth = img.width * scale;
              const drawHeight = img.height * scale;
              const dx = (128 - drawWidth) / 2;
              const dy = (128 - drawHeight) / 2;
              ctx.drawImage(img, dx, dy, drawWidth, drawHeight);
              resolve(canvas.toDataURL('image/png'));
            };
            img.onerror = () => reject(new Error('Unable to read image file.'));
            img.src = event.target.result;
          };
          reader.onerror = () => reject(new Error('Unable to read image file.'));
          reader.readAsDataURL(file);
        });

      const resetCobrandForm = () => {
        if (!cobrandForm) return;
        cobrandForm.reset();
        compressedLogoData = null;
        if (sellerIdInput) sellerIdInput.value = '';
        if (logoPreview) logoPreview.src = LOGO_PLACEHOLDER;
        if (sellerSuggestions) sellerSuggestions.classList.add('hidden');
        setStatus(cobrandFormStatus, '');
      };

      if (viewTabsWrapper) {
        viewTabsWrapper.addEventListener('click', (event) => {
          const btn = event.target.closest('[data-view]');
          if (!btn) return;
          toggleView(btn.dataset.view);
        });
      }

      weeklyHeadRows.forEach((headRow) => {
        headRow.addEventListener('click', (event) => {
          const th = event.target.closest('th[data-sort]');
          if (!th) return;
          const field = th.dataset.sort;
          if (!field) return;
          if (weeklySort.field === field) {
            weeklySort.direction = weeklySort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            weeklySort.field = field;
            weeklySort.direction = field === 'name' ? 'asc' : 'desc';
          }
          renderWeeklyHeadLabels();
          renderTable();
        });
      });

      if (cobrandTableHead) {
        cobrandTableHead.addEventListener('click', (event) => {
          const th = event.target.closest('th[data-sort]');
          if (!th) return;
          const field = th.dataset.sort;
          if (cobrandSort.field === field) {
            cobrandSort.direction = cobrandSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            cobrandSort.field = field;
            cobrandSort.direction = field === 'company_name' ? 'asc' : 'desc';
          }
          loadCobrandDeals();
        });
      }

      if (refreshWeekBtn) {
        refreshWeekBtn.addEventListener('click', () => {
          loadGiftTrackerData();
          loadCobrandTotalsForTracker();
        });
      }
      if (loadRosterBtn) {
        loadRosterBtn.addEventListener('click', () => {
          loadDailyRoster();
        });
      }
      if (rosterDateInput) {
        rosterDateInput.addEventListener('change', () => {
          loadDailyRoster();
        });
      }
      if (rosterStoreInput) {
        rosterStoreInput.addEventListener('change', () => {
          loadDailyRoster();
        });
      }

      if (saveWeekBtn) {
        saveWeekBtn.addEventListener('click', saveCurrentWeek);
      }

      if (drawBtn) {
        drawBtn.addEventListener('click', performDraw);
      }
      if (resetDrawsBtn) {
        resetDrawsBtn.addEventListener('click', resetDraws);
      }
      if (viewResultsBtn) {
        viewResultsBtn.addEventListener('click', viewResults);
      }

      if (refreshCobrandsBtn) {
        refreshCobrandsBtn.addEventListener('click', loadCobrandDeals);
      }

      if (refreshPayoutsBtn) {
        refreshPayoutsBtn.addEventListener('click', async () => {
          await loadTiers();
          await loadRules();
          await loadPrizes();
          await loadPayoutSummary();
        });
      }
      if (addTierBtn) addTierBtn.addEventListener('click', openTierModal);
      if (addRuleBtn) addRuleBtn.addEventListener('click', openRuleModal);
      if (addPrizeBtn) addPrizeBtn.addEventListener('click', openPrizeModal);
      if (seasonSelect) {
        seasonSelect.addEventListener('change', (event) => {
          selectedSeasonYear = Number(event.target.value);
          initData(serverNames);
          cobrandTotalsBySeller = {};
          cobrandDayCredits = {};
          cobrandDeals = [];
          renderWeeklyHeadLabels();
          renderTable();
          loadGiftTrackerData();
          loadCobrandTotalsForTracker();
          loadPayoutSummary();
          loadTiers();
          loadRules();
          loadPrizes();
        });
      }
      if (addSeasonBtn) {
        addSeasonBtn.addEventListener('click', openSeasonModal);
      }

      if (sellerInput) {
        sellerInput.addEventListener('input', (event) => {
          if (sellerIdInput) sellerIdInput.value = '';
          const term = event.target.value.trim();
          if (!term || term.length < 2) {
            if (sellerSuggestions) sellerSuggestions.classList.add('hidden');
            return;
          }
          clearTimeout(sellerSearchTimeout);
          sellerSearchTimeout = setTimeout(() => fetchSellerSuggestions(term), 250);
        });
      }

      if (sellerSuggestions) {
        sellerSuggestions.addEventListener('click', (event) => {
          const item = event.target.closest('li[data-id]');
          if (!item) return;
          if (sellerIdInput) sellerIdInput.value = item.dataset.id;
          if (sellerInput) sellerInput.value = item.dataset.value;
          sellerSuggestions.classList.add('hidden');
        });
      }

      document.addEventListener('click', (event) => {
        if (!event.target.closest('.seller-field') && sellerSuggestions) {
          sellerSuggestions.classList.add('hidden');
        }
      });

      if (amountInput) {
        amountInput.addEventListener('blur', () => {
          const value = parseUsdValue(amountInput.value);
          amountInput.value = value ? formatUsdDisplay(value) : '';
        });
      }

      if (logoInput) {
        logoInput.addEventListener('change', async (event) => {
          const file = event.target.files && event.target.files[0];
          if (!file) {
            compressedLogoData = null;
            if (logoPreview) logoPreview.src = LOGO_PLACEHOLDER;
            return;
          }
          try {
            setStatus(cobrandFormStatus, 'Processing logo...');
            compressedLogoData = await compressLogo(file);
            if (logoPreview) logoPreview.src = compressedLogoData;
            setStatus(cobrandFormStatus, '');
          } catch (err) {
            console.error(err);
            setStatus(cobrandFormStatus, err.message || 'Unable to process logo', true);
            event.target.value = '';
            compressedLogoData = null;
          }
        });
      }

      if (resetCobrandBtn) {
        resetCobrandBtn.addEventListener('click', () => {
          resetCobrandForm();
        });
      }

      if (cobrandForm) {
        cobrandForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (isSavingCobrand) return;
          const companyName = companyNameInput ? companyNameInput.value.trim() : '';
          const amountValue = parseUsdValue(amountInput ? amountInput.value : '');
          if (!companyName) {
            setStatus(cobrandFormStatus, 'Company name is required.', true);
            return;
          }
          if (!amountValue || amountValue <= 0) {
            setStatus(cobrandFormStatus, 'Enter a valid USD amount.', true);
            return;
          }
          const payload = {
            company_name: companyName,
            amount_usd: amountValue.toFixed(2),
            date_of_commission: commissionInput && commissionInput.value ? commissionInput.value : null,
            date_of_payment: paymentInput && paymentInput.value ? paymentInput.value : null,
            date_of_pickup: pickupInput && pickupInput.value ? pickupInput.value : null,
            seller_id: sellerIdInput && sellerIdInput.value ? Number(sellerIdInput.value) : null,
            logo_base64: compressedLogoData,
            season_year: getSeasonYear(),
          };
          setStatus(cobrandFormStatus, 'Saving deal...');
          isSavingCobrand = true;
          if (saveCobrandBtn) saveCobrandBtn.disabled = true;
          try {
            const resp = await authFetch('/cobrands', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(payload),
            });
            if (!resp.ok) throw new Error(`Unable to save deal (${resp.status})`);
            setStatus(cobrandFormStatus, 'Cobrand deal saved!');
            resetCobrandForm();
            loadCobrandDeals();
          } catch (err) {
            console.error(err);
            setStatus(cobrandFormStatus, err.message || 'Unable to save deal', true);
          } finally {
            isSavingCobrand = false;
            if (saveCobrandBtn) saveCobrandBtn.disabled = false;
          }
        });
      }

      const init = async () => {
        await loadSeasonsFromServer();
        await determineRole();
        try {
          serverNames = await loadServerRoster();
          modeSubtitle.textContent = isAdmin
            ? 'Editing live roster data. Save weeks to persist.'
            : 'Viewing live roster data.';
          setStatus(statusMsg, `Loaded ${serverNames.length} servers from roster.`);
        } catch (err) {
          console.error(err);
          setStatus(statusMsg, err.message || 'Could not load roster.', true);
          serverNames = [];
        }
        if (serverNames.length) {
          initData(serverNames);
          initChristmasData(serverNames);
        } else {
          if (activeTbody) {
            activeTbody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:#ff9b9b;">No roster data loaded. Please log in as an authenticated user.</td></tr>';
          }
          if (inactiveRosterSection) inactiveRosterSection.classList.add('hidden');
          renderTabs();
          return;
        }
        renderTabs();
        renderSeasonSelect();
        renderWeeklyHeadLabels();
        if (rosterDateInput && !rosterDateInput.value) {
          rosterDateInput.value = new Date().toISOString().split('T')[0];
        }
        await loadDailyRoster();
        await loadGiftTrackerData();
        await loadCobrandTotalsForTracker();
        renderChristmasHead();
        renderChristmasTable();
        renderTable();
        markWeekDirty(false);
      };

      toggleView('weekly');
      updateSortIndicators();
      const initialize = async () => {
        const ok = await ensureAuthenticated();
        if (!ok) return;
        await init();
      };
      initialize();
    </script>

  </body>
</html>
