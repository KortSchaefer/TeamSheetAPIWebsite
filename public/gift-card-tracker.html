<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Gift Card Tracker</title>
    <style>
      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at 20% 20%, #1f2b55, #080d1c 60%);
        color: #f5f7ff;
        font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      }
      .status {
        color: #9bb0ff;
        font-size: .95rem;
      }
      .status.error {
        color: #ff9b9b;
      }
      .card {
        width: min(1200px, 96vw);
        background: rgba(10, 18, 35, 0.85);
        border-radius: 28px;
        padding: 2rem;
        border: 1px solid #1f2d51;
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.45);
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .back-btn {
        position: fixed;
        top: 18px;
        left: 18px;
        border: 1px solid #243258;
        background: rgba(10, 18, 35, 0.85);
        color: #9bb0ff;
        padding: .45rem .75rem;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
      }
      .back-btn:hover {
        color: #cfe0ff;
        border-color: #4b7bff;
      }
      h1 {
        margin: 0;
        font-size: 2rem;
      }
      p {
        margin: 0;
        color: #a4b6e6;
      }
      .tabs {
        display: flex;
        gap: .6rem;
        flex-wrap: wrap;
      }
      .view-tabs {
        display: flex;
        gap: .6rem;
        flex-wrap: wrap;
        margin-top: .5rem;
      }
      .view-tab {
        border: 1px solid #243258;
        background: transparent;
        color: #dbe3ff;
        padding: .45rem 1.1rem;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: .03em;
      }
      .view-tab.active {
        border-color: #4b7bff;
        color: #fff;
        background: rgba(75, 123, 255, 0.2);
        box-shadow: 0 0 18px rgba(75, 123, 255, 0.3);
      }
      .tab {
        border: 1px solid #243258;
        background: #0f1831;
        color: #dbe3ff;
        padding: .5rem 1rem;
        border-radius: 12px;
        cursor: pointer;
      }
      .tab.active {
        border-color: #4b7bff;
        box-shadow: 0 0 0 1px rgba(75, 123, 255, 0.4);
      }
      .hidden {
        display: none !important;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        color: #dbe3ff;
        font-size: .95rem;
      }
      th, td {
        border: 1px solid #10172c;
        padding: .55rem .7rem;
        text-align: center;
      }
      thead th {
        background: #0f1f40;
        text-transform: uppercase;
        font-size: .8rem;
        letter-spacing: .05em;
      }
      tbody tr:nth-child(odd) {
        background: rgba(255, 255, 255, 0.02);
      }
      input[type="number"] {
        width: 100%;
        padding: .35rem .4rem;
        border-radius: 8px;
        border: 1px solid #243258;
        background: #0a1223;
        color: #f5f7ff;
        text-align: right;
      }
      input[type="number"]:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        color: #98a4c4;
      }
      .mode-pill {
        align-self: flex-start;
        padding: .35rem .75rem;
        border-radius: 999px;
        border: 1px solid #2a365a;
        background: rgba(255,255,255,0.05);
        color: #9bb0ff;
        font-weight: 600;
        font-size: .9rem;
      }
      .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
      }
      .panel {
        background: rgba(7, 14, 28, 0.6);
        border: 1px solid #1d2747;
        border-radius: 22px;
        padding: 1.5rem;
        margin-top: 1.2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .panel-header {
        display: flex;
        flex-wrap: wrap;
        gap: .6rem;
        justify-content: space-between;
        align-items: center;
      }
      .panel h2 {
        margin: 0;
        font-size: 1.3rem;
      }
      .panel-subtitle {
        margin: 0;
        color: #91a3de;
        font-size: .95rem;
      }
      .cobrand-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
      }
      .form-field {
        display: flex;
        flex-direction: column;
        gap: .35rem;
      }
      .form-field label {
        text-transform: uppercase;
        font-size: .8rem;
        letter-spacing: .08em;
        color: #9bb0ff;
      }
      .form-field input,
      .form-field select {
        border-radius: 10px;
        border: 1px solid #243258;
        background: #050b1c;
        color: #f5f7ff;
        padding: .5rem .6rem;
        font-size: 1rem;
      }
      .form-field input::placeholder {
        color: #506097;
      }
      .field-hint {
        font-size: .8rem;
        color: #8795c4;
      }
      .form-field.full-row {
        grid-column: 1 / -1;
      }
      .file-input {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      .logo-preview {
        width: 72px;
        height: 72px;
        border-radius: 16px;
        border: 1px dashed #2a3c70;
        background: #0a152d;
        object-fit: contain;
      }
      .seller-field {
        position: relative;
      }
      .seller-input {
        position: relative;
      }
      .seller-suggestions {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        background: #070f25;
        border: 1px solid #243258;
        border-radius: 12px;
        max-height: 230px;
        overflow-y: auto;
        z-index: 20;
        padding: 0;
        margin: 0;
      }
      .seller-suggestions.hidden {
        display: none;
      }
      .seller-suggestions li {
        list-style: none;
        padding: .5rem .7rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: .5rem;
      }
      .seller-suggestions li.muted {
        cursor: default;
        color: #6d78a6;
      }
      .seller-suggestions li:hover:not(.muted) {
        background: rgba(75, 123, 255, 0.15);
      }
      .tag {
        font-size: .7rem;
        text-transform: uppercase;
        letter-spacing: .08em;
        border: 1px solid #2f3f6b;
        border-radius: 999px;
        padding: .1rem .4rem;
        color: #9bb0ff;
      }
      .form-actions {
        display: flex;
        flex-wrap: wrap;
        gap: .8rem;
        align-items: center;
      }
      .primary-btn {
        background: linear-gradient(120deg, #566ff8, #8c68ff);
        border: none;
        border-radius: 12px;
        color: #fff;
        padding: .6rem 1.4rem;
        font-weight: 600;
        cursor: pointer;
      }
      .primary-btn:disabled {
        opacity: .6;
        cursor: not-allowed;
      }
      .ghost-btn {
        border: 1px solid #2c3c68;
        background: transparent;
        color: #dbe3ff;
        border-radius: 12px;
        padding: .4rem 1rem;
        cursor: pointer;
      }
      .table-scroll {
        overflow-x: auto;
      }
      .cobrands-table th[data-sort] {
        cursor: pointer;
        user-select: none;
      }
      .cobrands-table th[data-sort]::after {
        content: attr(data-direction);
        font-size: .75rem;
        padding-left: .35rem;
        color: #7d8ec2;
      }
      .cobrands-table th[data-sort]:not(.sorted)::after {
        content: "";
      }
      .actions-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: .8rem;
        margin: .6rem 0;
      }
      @keyframes pulseGlow {
        0% { box-shadow: 0 0 0 0 rgba(86, 111, 248, 0.5); }
        50% { box-shadow: 0 0 0 8px rgba(86, 111, 248, 0.0); }
        100% { box-shadow: 0 0 0 0 rgba(86, 111, 248, 0.0); }
      }
      .pulse {
        animation: pulseGlow 1.6s ease-out infinite;
      }
    </style>
  </head>
  <body>
    <button class="back-btn" onclick="window.location.href='/static/index.html'">← Back</button>
    <div class="card">
      <div class="header-row">
        <div>
          <h1>Gift Card Tracker</h1>
          <p id="mode-subtitle">Loading mode...</p>
        </div>
        <div id="mode-pill" class="mode-pill">Checking role...</div>
      </div>
      <div class="view-tabs" id="view-tabs">
        <button class="view-tab active" type="button" data-view="weekly">Weekly Tracker</button>
        <button class="view-tab" type="button" data-view="cobrands">Cobrands</button>
      </div>
      <section id="weekly-view">
        <div class="tabs" id="tabs"></div>
        <div class="actions-row">
          <button class="primary-btn" type="button" id="save-week-btn">Save Week</button>
          <button class="ghost-btn" type="button" id="refresh-week-btn">Reload Week</button>
          <div class="status" id="weekly-status"></div>
        </div>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>Server</th>
                <th>Tuesday</th>
                <th>Wednesday</th>
                <th>Thursday</th>
                <th>Friday</th>
                <th>Saturday</th>
                <th>Sunday</th>
                <th>Monday</th>
                <th>This Week</th>
                <th>YTD</th>
                <th>Goal</th>
              </tr>
            </thead>
            <tbody id="table-body"></tbody>
          </table>
        </div>
      </section>
      <section id="cobrands-view" class="hidden">
        <div class="panel">
          <div class="panel-header">
            <div>
              <h2>Create Cobrand Deal</h2>
              <p class="panel-subtitle">Store details and logos for every partnership.</p>
            </div>
          </div>
          <form id="cobrand-form" class="cobrand-form" autocomplete="off">
            <div class="form-field full-row">
              <label for="company-name">Company Name *</label>
              <input id="company-name" type="text" required placeholder="e.g., Downtown Bakery" />
            </div>
            <div class="form-field">
              <label for="cobrand-amount">Amount (USD) *</label>
              <input id="cobrand-amount" type="text" inputmode="decimal" placeholder="$0.00" required />
            </div>
            <div class="form-field">
              <label for="commission-date">Date of Commission</label>
              <input id="commission-date" type="date" />
            </div>
            <div class="form-field">
              <label for="payment-date">Date of Payment</label>
              <input id="payment-date" type="date" />
            </div>
            <div class="form-field">
              <label for="pickup-date">Date of Pickup</label>
              <input id="pickup-date" type="date" />
            </div>
            <div class="form-field seller-field full-row">
              <label for="seller-input">Seller</label>
              <div class="seller-input">
                <input id="seller-input" type="text" placeholder="Search active servers or managers" autocomplete="off" />
                <input type="hidden" id="seller-id" />
                <ul id="seller-suggestions" class="seller-suggestions hidden"></ul>
              </div>
              <div class="field-hint">Start typing at least 2 characters to search.</div>
            </div>
            <div class="form-field full-row">
              <label for="logo-input">Company Logo</label>
              <div class="file-input">
                <input id="logo-input" type="file" accept="image/*" />
                <img
                  id="logo-preview"
                  class="logo-preview"
                  alt="Logo preview"
                  src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
                />
              </div>
              <div class="field-hint">Images are automatically resized to 128×128.</div>
            </div>
            <div class="form-field full-row">
              <div class="form-actions">
                <button class="primary-btn" type="submit" id="save-cobrand">Save Deal</button>
                <button class="ghost-btn" type="button" id="reset-cobrand">Reset</button>
                <div class="status" id="cobrand-form-status"></div>
              </div>
            </div>
          </form>
        </div>
        <div class="panel">
          <div class="panel-header">
            <h2>Saved Cobrand Deals</h2>
            <button class="ghost-btn" type="button" id="refresh-cobrands">Refresh</button>
          </div>
          <div class="status" id="cobrand-status"></div>
          <div class="table-scroll">
            <table class="cobrands-table">
              <thead id="cobrands-head">
                <tr>
                  <th data-sort="company_name">Company</th>
                  <th data-sort="amount">Amount</th>
                  <th data-sort="date_of_commission">Commission</th>
                  <th data-sort="date_of_payment">Payment</th>
                  <th data-sort="date_of_pickup">Pickup</th>
                  <th>Seller</th>
                  <th>Logo</th>
                  <th data-sort="created_at">Created</th>
                </tr>
              </thead>
              <tbody id="cobrands-body">
                <tr>
                  <td colspan="8" style="text-align:center;color:#8ea0d6;">Switch to the Cobrands tab to load deals.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
    <script>
      const UNIVERSAL_GOAL = 4000;
      const LOGO_PLACEHOLDER = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
      const days = ['Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday', 'Monday'];
      const fallbackServers = [
        'Alex Thompson',
        'Brianna Lopez',
        'Carlos Mendoza',
        'Danielle Harper',
        'Ethan Brooks',
        'Faith Reynolds',
      ];
      const weeksCount = 8;

      const tabsEl = document.getElementById('tabs');
      const tbody = document.getElementById('table-body');
      const modePill = document.getElementById('mode-pill');
      const modeSubtitle = document.getElementById('mode-subtitle');
      const statusMsg = document.createElement('div');
      statusMsg.className = 'status';
      document.querySelector('.card').appendChild(statusMsg);
      const COOKIE_MAX_AGE = 60 * 60 * 24 * 7;

      const viewTabsWrapper = document.getElementById('view-tabs');
      const weeklyView = document.getElementById('weekly-view');
      const cobrandsView = document.getElementById('cobrands-view');
      const saveWeekBtn = document.getElementById('save-week-btn');
      const refreshWeekBtn = document.getElementById('refresh-week-btn');
      const weeklyStatus = document.getElementById('weekly-status');
      const cobrandForm = document.getElementById('cobrand-form');
      const cobrandFormStatus = document.getElementById('cobrand-form-status');
      const cobrandStatus = document.getElementById('cobrand-status');
      const cobrandTableBody = document.getElementById('cobrands-body');
      const cobrandTableHead = document.getElementById('cobrands-head');
      const refreshCobrandsBtn = document.getElementById('refresh-cobrands');
      const companyNameInput = document.getElementById('company-name');
      const amountInput = document.getElementById('cobrand-amount');
      const commissionInput = document.getElementById('commission-date');
      const paymentInput = document.getElementById('payment-date');
      const pickupInput = document.getElementById('pickup-date');
      const sellerInput = document.getElementById('seller-input');
      const sellerIdInput = document.getElementById('seller-id');
      const sellerSuggestions = document.getElementById('seller-suggestions');
      const logoInput = document.getElementById('logo-input');
      const logoPreview = document.getElementById('logo-preview');
      const resetCobrandBtn = document.getElementById('reset-cobrand');
      const saveCobrandBtn = document.getElementById('save-cobrand');

      let isAdmin = false;
      let currentWeek = 1;
      let giftData = {};
      let serverNames = [];
      let cobrandsLoaded = false;
      let cobrandDeals = [];
      let cobrandSort = { field: 'created_at', direction: 'desc' };
      let compressedLogoData = null;
      let sellerSearchTimeout;
      let sellerSearchAbort;
      let isSavingCobrand = false;
      let giftTrackerLoaded = false;
      let isSavingWeek = false;
      let isWeekDirty = false;
      let cobrandTotalsBySeller = {};

      const dayKeys = ['tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday', 'monday'];

      const setStatus = (node, message, isError = false) => {
        if (!node) return;
        if (!message) {
          node.textContent = '';
          node.classList.remove('error');
          return;
        }
        node.textContent = message;
        node.classList.toggle('error', Boolean(isError));
      };

      const markWeekDirty = (dirty) => {
        isWeekDirty = dirty;
        if (saveWeekBtn) {
          if (dirty) {
            saveWeekBtn.classList.add('pulse');
          } else {
            saveWeekBtn.classList.remove('pulse');
          }
        }
      };

      const loadCobrandTotalsForTracker = async () => {
        const token = getStoredToken();
        if (!token) return;
        try {
          const resp = await fetch('/cobrands', { headers: { Authorization: `Bearer ${token}` } });
          if (!resp.ok) throw new Error(`Unable to load cobrands (${resp.status})`);
          const deals = await resp.json();
          const totals = {};
          deals.forEach((deal) => {
            if (!deal.seller_name || deal.amount_usd === undefined || deal.amount_usd === null) return;
            const key = deal.seller_name.trim().toLowerCase();
            totals[key] = (totals[key] || 0) + Number(deal.amount_usd || 0);
          });
          cobrandTotalsBySeller = totals;
          if (Object.keys(totals).length) {
            setStatus(
              weeklyStatus,
              `Cobrands synced for ${Object.keys(totals).length} seller${Object.keys(totals).length === 1 ? '' : 's'}.`,
            );
          }
        } catch (err) {
          console.error(err);
          setStatus(weeklyStatus, err.message || 'Unable to sync cobrands', true);
        }
      };

      const formatUsdDisplay = (value) => {
        if (!Number.isFinite(value)) return '$0.00';
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
      };

      const parseUsdValue = (value) => {
        if (!value) return null;
        const sanitized = value.replace(/[^0-9.]/g, '');
        if (!sanitized) return null;
        return Number(sanitized);
      };

      const formatDateLabel = (value) => {
        if (!value) return '—';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return '—';
        return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
      };

      const getStoredToken = () => {
        const cookieMatch = document.cookie
          .split(';')
          .map((c) => c.trim())
          .find((c) => c.startsWith('tss_access_token='));
        if (cookieMatch) return cookieMatch.split('=')[1];
        return localStorage.getItem('tss_access_token');
      };

      const setStoredTokens = (access, refresh) => {
        if (access) {
          document.cookie = `tss_access_token=${access}; path=/; max-age=${COOKIE_MAX_AGE}; SameSite=Lax`;
          localStorage.setItem('tss_access_token', access);
        }
        if (refresh) {
          document.cookie = `tss_refresh_token=${refresh}; path=/; max-age=${COOKIE_MAX_AGE}; SameSite=Lax`;
          localStorage.setItem('tss_refresh_token', refresh);
        }
      };

      const initData = (names) => {
        giftData = {};
        for (let w = 1; w <= weeksCount; w++) {
          giftData[w] = names.map((name) => {
            const entries = {};
            days.forEach((d) => {
              entries[d] = 0;
            });
            return { name, ...entries };
          });
        }
      };

      const computeYtdMap = () => {
        const ytd = {};
        for (let w = 1; w <= weeksCount; w++) {
          giftData[w].forEach((row) => {
            const weekTotal = days.reduce((sum, d) => sum + Number(row[d] || 0), 0);
            ytd[row.name] = (ytd[row.name] || 0) + weekTotal;
          });
        }
        return ytd;
      };

      const ensureWeekData = (week) => {
        if (!giftData[week]) {
          giftData[week] = [];
        }
      };

      const upsertWeekEntry = (week, entry) => {
        ensureWeekData(week);
        const lower = entry.employee_name.toLowerCase();
        let row = giftData[week].find((r) => r.name.toLowerCase() === lower);
        if (!row) {
          row = { name: entry.employee_name };
          days.forEach((d) => {
            row[d] = 0;
          });
          giftData[week].push(row);
        }
        days.forEach((d) => {
          const key = d.toLowerCase();
          const val = entry[key];
          row[d] = (val !== undefined && val !== null && !Number.isNaN(Number(val))) ? Number(val) : 0;
        });
      };

      const loadServerRoster = async () => {
        const token = getStoredToken();
        if (!token) throw new Error('No token found. Please log in first.');
        const resp = await fetch('/employees?role=SERVER&active=true', {
          headers: { Authorization: `Bearer ${token}` },
        });
        if (resp.status === 401) throw new Error('Unauthorized. Log in again to load servers.');
        if (!resp.ok) throw new Error(`Roster fetch failed (${resp.status})`);
        const data = await resp.json();
        if (!Array.isArray(data) || !data.length) throw new Error('Empty roster');
        return data.map((emp) => `${emp.first_name} ${emp.last_name}`.trim());
      };

      const renderTabs = () => {
        tabsEl.innerHTML = '';
        for (let w = 1; w <= weeksCount; w++) {
          const btn = document.createElement('button');
          btn.className = 'tab' + (w === currentWeek ? ' active' : '');
          btn.textContent = `Week ${w}`;
          btn.addEventListener('click', () => {
            currentWeek = w;
            renderTabs();
            renderTable();
          });
          tabsEl.appendChild(btn);
        }
      };

      const loadGiftTrackerData = async () => {
        const token = getStoredToken();
        if (!token) {
          setStatus(weeklyStatus, 'Log in to load weekly tracker data.', true);
          return;
        }
        setStatus(weeklyStatus, 'Loading weekly tracker data...');
        try {
          const resp = await fetch('/gift-tracker', {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!resp.ok) throw new Error(`Unable to load tracker data (${resp.status})`);
          const entries = await resp.json();
          entries.forEach((entry) => {
            const weekNum = Number(entry.week_number);
            if (!Number.isFinite(weekNum) || weekNum < 1 || weekNum > weeksCount) return;
            upsertWeekEntry(weekNum, entry);
          });
          giftTrackerLoaded = true;
          setStatus(
            weeklyStatus,
            `Synced ${entries.length} tracker entr${entries.length === 1 ? 'y' : 'ies'}.`,
          );
          markWeekDirty(false);
          renderTable();
        } catch (err) {
          console.error(err);
          setStatus(weeklyStatus, err.message || 'Unable to load weekly tracker data', true);
        }
      };

      const saveCurrentWeek = async () => {
        if (!isAdmin) {
          setStatus(weeklyStatus, 'You need edit access to save.', true);
          return;
        }
        const token = getStoredToken();
        if (!token) {
          setStatus(weeklyStatus, 'Log in to save weekly tracker data.', true);
          return;
        }
        const rows = giftData[currentWeek] || [];
        const entries = rows.map((row) => {
          const payload = { employee_name: row.name };
          days.forEach((d) => {
            payload[d.toLowerCase()] = Number(row[d] || 0);
          });
          return payload;
        });
        const body = {
          week_number: currentWeek,
          entries,
        };
        setStatus(weeklyStatus, 'Saving week...');
        isSavingWeek = true;
        if (saveWeekBtn) saveWeekBtn.disabled = true;
        try {
          const resp = await fetch('/gift-tracker', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(body),
          });
          if (!resp.ok) throw new Error(`Unable to save week (${resp.status})`);
          const saved = await resp.json();
          saved.forEach((entry) => {
            upsertWeekEntry(currentWeek, entry);
          });
          markWeekDirty(false);
          setStatus(weeklyStatus, 'Week saved to server.');
          renderTable();
        } catch (err) {
          console.error(err);
          setStatus(weeklyStatus, err.message || 'Unable to save week', true);
        } finally {
          isSavingWeek = false;
          if (saveWeekBtn) saveWeekBtn.disabled = !isAdmin;
        }
      };

      const renderTable = () => {
        const ytdMap = computeYtdMap();
        const rows = giftData[currentWeek];
        tbody.innerHTML = '';
        rows.forEach((row, rowIndex) => {
          const tr = document.createElement('tr');
          const weekTotal = days.reduce((sum, d) => sum + Number(row[d] || 0), 0);
          const cobrandBonus = cobrandTotalsBySeller[row.name.toLowerCase()] || 0;
          const weekWithBonus = weekTotal + cobrandBonus;
          const ytd = (ytdMap[row.name] || 0) + cobrandBonus;
          const goal = UNIVERSAL_GOAL - ytd;
          tr.innerHTML = `
            <td style="text-align:left;font-weight:600;">${row.name}</td>
            ${days
              .map((d) => {
                const val = row[d] ?? 0;
                if (isAdmin) {
                  return `<td><input type="number" min="0" step="1" data-row="${rowIndex}" data-day="${d}" value="${val}"></td>`;
                }
                return `<td>${val}</td>`;
              })
              .join('')}
            <td>${cobrandBonus ? `${weekWithBonus} (+${cobrandBonus} cb)` : weekWithBonus}</td>
            <td>${ytd}</td>
            <td>${goal}</td>
          `;
          tbody.appendChild(tr);
        });

        if (isAdmin) {
          tbody.querySelectorAll('input').forEach((input) => {
            input.addEventListener('change', (e) => {
              const rowIdx = Number(e.target.dataset.row);
              const day = e.target.dataset.day;
              const val = Number(e.target.value || 0);
              giftData[currentWeek][rowIdx][day] = val;
              markWeekDirty(true);
              renderTable();
            });
          });
        }
      };

      const determineRole = async () => {
        try {
          const token = getStoredToken();
          if (!token) throw new Error('No token, view only');
          const resp = await fetch('/auth/me', { headers: { Authorization: `Bearer ${token}` } });
          if (!resp.ok) throw new Error('Not authenticated');
          const me = await resp.json();
          isAdmin = me.role === 'ADMIN' || me.role === 'MANAGER';
          modePill.textContent = isAdmin ? 'Edit mode (Admin/Manager)' : 'View only';
          modeSubtitle.textContent = isAdmin
            ? 'You can edit daily amounts. Save to sync with the server.'
            : 'View-only mode. Contact an admin to update values.';
          if (saveWeekBtn) saveWeekBtn.disabled = !isAdmin;
        } catch (err) {
          isAdmin = false;
          modePill.textContent = 'View only';
          modeSubtitle.textContent = 'View-only mode. Sign in as an admin to edit.';
          if (saveWeekBtn) saveWeekBtn.disabled = true;
        }
      };

      const toggleView = (view) => {
        if (!viewTabsWrapper) return;
        viewTabsWrapper.querySelectorAll('.view-tab').forEach((tab) => {
          tab.classList.toggle('active', tab.dataset.view === view);
        });
        if (weeklyView) weeklyView.classList.toggle('hidden', view !== 'weekly');
        if (cobrandsView) cobrandsView.classList.toggle('hidden', view !== 'cobrands');
        if (view === 'cobrands' && !cobrandsLoaded) {
          loadCobrandDeals();
        }
      };

      const updateSortIndicators = () => {
        if (!cobrandTableHead) return;
        cobrandTableHead.querySelectorAll('th[data-sort]').forEach((th) => {
          const active = th.dataset.sort === cobrandSort.field;
          th.classList.toggle('sorted', active);
          th.dataset.direction = active ? (cobrandSort.direction === 'desc' ? '▼' : '▲') : '';
        });
      };

      const renderCobrandDeals = () => {
        if (!cobrandTableBody) return;
        if (!cobrandDeals.length) {
          cobrandTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#8ea0d6;">No cobrand deals have been logged.</td></tr>';
          return;
        }
        cobrandTableBody.innerHTML = cobrandDeals
          .map((deal) => {
            const logoCell = deal.logo_base64
              ? `<img src="${deal.logo_base64}" alt="${deal.company_name} logo" style="width:48px;height:48px;border-radius:12px;object-fit:contain;background:#050b16;border:1px solid #1f2f54;">`
              : '—';
            return `
              <tr>
                <td style="text-align:left;">${deal.company_name}</td>
                <td>${formatUsdDisplay(Number(deal.amount_usd))}</td>
                <td>${formatDateLabel(deal.date_of_commission)}</td>
                <td>${formatDateLabel(deal.date_of_payment)}</td>
                <td>${formatDateLabel(deal.date_of_pickup)}</td>
                <td>${deal.seller_name || '—'}</td>
                <td>${logoCell}</td>
                <td>${formatDateLabel(deal.created_at)}</td>
              </tr>
            `;
          })
          .join('');
      };

      const loadCobrandDeals = async () => {
        const token = getStoredToken();
        if (!token) {
          setStatus(cobrandStatus, 'Log in to view cobrand deals.', true);
          return;
        }
        setStatus(cobrandStatus, 'Loading deals...');
        try {
          const resp = await fetch(`/cobrands?sort_by=${cobrandSort.field}&sort_dir=${cobrandSort.direction}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!resp.ok) throw new Error(`Unable to load deals (${resp.status})`);
          cobrandDeals = await resp.json();
          setStatus(
            cobrandStatus,
            `Loaded ${cobrandDeals.length} deal${cobrandDeals.length === 1 ? '' : 's'}.`,
          );
          renderCobrandDeals();
          cobrandsLoaded = true;
        } catch (err) {
          console.error(err);
          setStatus(cobrandStatus, err.message || 'Unable to load deals', true);
        }
        updateSortIndicators();
      };

      const renderSellerSuggestions = (options) => {
        if (!sellerSuggestions) return;
        if (!options.length) {
          sellerSuggestions.innerHTML = '<li class="muted">No matches</li>';
        } else {
          sellerSuggestions.innerHTML = options
            .map(
              (opt) => `
                <li data-id="${opt.id}" data-value="${opt.name}">
                  <span>${opt.name}</span>
                  <span class="tag">${opt.role}</span>
                </li>
              `,
            )
            .join('');
        }
        sellerSuggestions.classList.remove('hidden');
      };

      const fetchSellerSuggestions = async (term) => {
        const token = getStoredToken();
        if (!token || !sellerSuggestions) return;
        if (sellerSearchAbort) sellerSearchAbort.abort();
        sellerSearchAbort = new AbortController();
        try {
          const resp = await fetch(`/cobrands/sellers?search=${encodeURIComponent(term)}`, {
            headers: { Authorization: `Bearer ${token}` },
            signal: sellerSearchAbort.signal,
          });
          if (!resp.ok) throw new Error('Unable to fetch sellers');
          const results = await resp.json();
          renderSellerSuggestions(results);
        } catch (err) {
          if (err.name === 'AbortError') return;
          console.error(err);
          sellerSuggestions.classList.add('hidden');
        }
      };

      const compressLogo = (file) =>
        new Promise((resolve, reject) => {
          if (!file.type.startsWith('image/')) {
            reject(new Error('Please choose an image file.'));
            return;
          }
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              canvas.width = 128;
              canvas.height = 128;
              const ctx = canvas.getContext('2d');
              ctx.clearRect(0, 0, 128, 128);
              const scale = Math.min(128 / img.width, 128 / img.height);
              const drawWidth = img.width * scale;
              const drawHeight = img.height * scale;
              const dx = (128 - drawWidth) / 2;
              const dy = (128 - drawHeight) / 2;
              ctx.drawImage(img, dx, dy, drawWidth, drawHeight);
              resolve(canvas.toDataURL('image/png'));
            };
            img.onerror = () => reject(new Error('Unable to read image file.'));
            img.src = event.target.result;
          };
          reader.onerror = () => reject(new Error('Unable to read image file.'));
          reader.readAsDataURL(file);
        });

      const resetCobrandForm = () => {
        if (!cobrandForm) return;
        cobrandForm.reset();
        compressedLogoData = null;
        if (sellerIdInput) sellerIdInput.value = '';
        if (logoPreview) logoPreview.src = LOGO_PLACEHOLDER;
        if (sellerSuggestions) sellerSuggestions.classList.add('hidden');
        setStatus(cobrandFormStatus, '');
      };

      if (viewTabsWrapper) {
        viewTabsWrapper.addEventListener('click', (event) => {
          const btn = event.target.closest('[data-view]');
          if (!btn) return;
          toggleView(btn.dataset.view);
        });
      }

      if (cobrandTableHead) {
        cobrandTableHead.addEventListener('click', (event) => {
          const th = event.target.closest('th[data-sort]');
          if (!th) return;
          const field = th.dataset.sort;
          if (cobrandSort.field === field) {
            cobrandSort.direction = cobrandSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            cobrandSort.field = field;
            cobrandSort.direction = field === 'company_name' ? 'asc' : 'desc';
          }
          loadCobrandDeals();
        });
      }

      if (refreshWeekBtn) {
        refreshWeekBtn.addEventListener('click', () => {
          loadGiftTrackerData();
          loadCobrandTotalsForTracker();
        });
      }

      if (saveWeekBtn) {
        saveWeekBtn.addEventListener('click', saveCurrentWeek);
      }

      if (refreshCobrandsBtn) {
        refreshCobrandsBtn.addEventListener('click', loadCobrandDeals);
      }

      if (sellerInput) {
        sellerInput.addEventListener('input', (event) => {
          if (sellerIdInput) sellerIdInput.value = '';
          const term = event.target.value.trim();
          if (!term || term.length < 2) {
            if (sellerSuggestions) sellerSuggestions.classList.add('hidden');
            return;
          }
          clearTimeout(sellerSearchTimeout);
          sellerSearchTimeout = setTimeout(() => fetchSellerSuggestions(term), 250);
        });
      }

      if (sellerSuggestions) {
        sellerSuggestions.addEventListener('click', (event) => {
          const item = event.target.closest('li[data-id]');
          if (!item) return;
          if (sellerIdInput) sellerIdInput.value = item.dataset.id;
          if (sellerInput) sellerInput.value = item.dataset.value;
          sellerSuggestions.classList.add('hidden');
        });
      }

      document.addEventListener('click', (event) => {
        if (!event.target.closest('.seller-field') && sellerSuggestions) {
          sellerSuggestions.classList.add('hidden');
        }
      });

      if (amountInput) {
        amountInput.addEventListener('blur', () => {
          const value = parseUsdValue(amountInput.value);
          amountInput.value = value ? formatUsdDisplay(value) : '';
        });
      }

      if (logoInput) {
        logoInput.addEventListener('change', async (event) => {
          const file = event.target.files && event.target.files[0];
          if (!file) {
            compressedLogoData = null;
            if (logoPreview) logoPreview.src = LOGO_PLACEHOLDER;
            return;
          }
          try {
            setStatus(cobrandFormStatus, 'Processing logo...');
            compressedLogoData = await compressLogo(file);
            if (logoPreview) logoPreview.src = compressedLogoData;
            setStatus(cobrandFormStatus, '');
          } catch (err) {
            console.error(err);
            setStatus(cobrandFormStatus, err.message || 'Unable to process logo', true);
            event.target.value = '';
            compressedLogoData = null;
          }
        });
      }

      if (resetCobrandBtn) {
        resetCobrandBtn.addEventListener('click', () => {
          resetCobrandForm();
        });
      }

      if (cobrandForm) {
        cobrandForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (isSavingCobrand) return;
          const companyName = companyNameInput ? companyNameInput.value.trim() : '';
          const amountValue = parseUsdValue(amountInput ? amountInput.value : '');
          if (!companyName) {
            setStatus(cobrandFormStatus, 'Company name is required.', true);
            return;
          }
          if (!amountValue || amountValue <= 0) {
            setStatus(cobrandFormStatus, 'Enter a valid USD amount.', true);
            return;
          }
          const token = getStoredToken();
          if (!token) {
            setStatus(cobrandFormStatus, 'Log in to save cobrand deals.', true);
            return;
          }
          const payload = {
            company_name: companyName,
            amount_usd: amountValue.toFixed(2),
            date_of_commission: commissionInput && commissionInput.value ? commissionInput.value : null,
            date_of_payment: paymentInput && paymentInput.value ? paymentInput.value : null,
            date_of_pickup: pickupInput && pickupInput.value ? pickupInput.value : null,
            seller_id: sellerIdInput && sellerIdInput.value ? Number(sellerIdInput.value) : null,
            logo_base64: compressedLogoData,
          };
          setStatus(cobrandFormStatus, 'Saving deal...');
          isSavingCobrand = true;
          if (saveCobrandBtn) saveCobrandBtn.disabled = true;
          try {
            const resp = await fetch('/cobrands', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(payload),
            });
            if (!resp.ok) throw new Error(`Unable to save deal (${resp.status})`);
            setStatus(cobrandFormStatus, 'Cobrand deal saved!');
            resetCobrandForm();
            loadCobrandDeals();
          } catch (err) {
            console.error(err);
            setStatus(cobrandFormStatus, err.message || 'Unable to save deal', true);
          } finally {
            isSavingCobrand = false;
            if (saveCobrandBtn) saveCobrandBtn.disabled = false;
          }
        });
      }

      const init = async () => {
        await determineRole();
        try {
          serverNames = await loadServerRoster();
          modeSubtitle.textContent = isAdmin
            ? 'Editing live roster data. Save weeks to persist.'
            : 'Viewing live roster data.';
          setStatus(statusMsg, `Loaded ${serverNames.length} servers from roster.`);
        } catch (err) {
          console.error(err);
          setStatus(statusMsg, err.message || 'Could not load roster.', true);
          serverNames = [];
        }
        if (serverNames.length) {
          initData(serverNames);
        } else {
          tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:#ff9b9b;">No roster data loaded. Please log in as an authenticated user.</td></tr>';
          renderTabs();
          return;
        }
        renderTabs();
        await loadGiftTrackerData();
        await loadCobrandTotalsForTracker();
        renderTable();
        markWeekDirty(false);
      };

      toggleView('weekly');
      updateSortIndicators();
      init();
    </script>

  </body>
</html>
