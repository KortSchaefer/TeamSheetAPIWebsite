<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Team Sheet Studio - Sign In</title>
    <style>
      :root {
        color-scheme: dark;
        font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top, #112850, #070c1a 55%);
        color: #f5f7ff;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }
      .login-shell {
        width: min(980px, 100%);
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        background: rgba(10, 18, 35, 0.9);
        border-radius: 32px;
        overflow: hidden;
        box-shadow: 0 30px 80px rgba(5, 5, 5, 0.6);
      }
      .brand {
        padding: 3rem;
        background: linear-gradient(160deg, #1c346e, #3c64ff);
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .brand h1 {
        margin: 0;
        font-size: 2.6rem;
      }
      .brand p {
        margin: 0;
        opacity: 0.9;
        line-height: 1.5;
      }
      .feature-list {
        list-style: none;
        padding: 0;
        margin: 1rem 0 0;
      }
      .feature-list li {
        margin-bottom: .4rem;
        display: flex;
        align-items: center;
        gap: .5rem;
      }
      .feature-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #86ffd3;
      }
      .login-card {
        padding: 3rem;
        background: #0c1630;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      form {
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
      }
      label {
        font-weight: 600;
        font-size: .9rem;
        color: #a7b4d8;
      }
      input, select {
        padding: .85rem 1rem;
        border-radius: 14px;
        border: 1px solid #202a48;
        background: #050919;
        color: #f5f7ff;
        font-size: 1rem;
        transition: border 0.2s;
      }
      input:focus, select:focus { outline: none; border-color: #4b7bff; }
      button {
        border: none;
        border-radius: 16px;
        padding: 1rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        background: linear-gradient(120deg, #4b63f7, #47a0ff);
        color: #fff;
      }
      button:hover { opacity: .95; }
      .ghost-btn {
        background: #0f1831;
        border: 1px solid #243258;
      }
      .status {
        min-height: 1.5rem;
        font-size: .9rem;
      }
      .status.error { color: #ff8b8b; }
      .status.success { color: #65f5b6; }
      .hidden { display: none !important; }
    </style>
  </head>
  <body>
    <div class="login-shell">
      <div class="brand">
        <p style="margin:0;">
          <span style="padding:.2rem .9rem;border-radius:999px;border:1px solid rgba(255,255,255,.35);font-size:.85rem;">
            Internal Tooling
          </span>
        </p>
        <h1>Team Sheet Studio</h1>
        <p>Sign in to access the Operations Hub and all manager tools.</p>
        <ul class="feature-list">
          <li><span class="feature-dot"></span>JWT-secured API</li>
          <li><span class="feature-dot"></span>Role-based access</li>
          <li><span class="feature-dot"></span>Gift card tracker + payouts</li>
        </ul>
      </div>
      <div class="login-card">
        <div>
          <h2 style="margin:0;">Welcome</h2>
          <p style="margin:.4rem 0 0;color:#7e8ab4;">Sign in or create a new account.</p>
        </div>
        <form id="login-form">
          <div>
            <label for="email">Email</label>
            <input id="email" type="email" placeholder="you@restaurant.com" required />
          </div>
          <div>
            <label for="password">Password</label>
            <input id="password" type="password" placeholder="••••••••" required />
          </div>
          <div id="register-fields" class="hidden">
            <div>
              <label for="full_name">Full Name</label>
              <input id="full_name" type="text" placeholder="Taylor Manager" />
            </div>
            <div>
              <label for="role">Role</label>
              <select id="role">
                <option value="MANAGER">Manager</option>
                <option value="ADMIN">Admin</option>
                <option value="SERVER">Server</option>
              </select>
            </div>
          </div>
          <button type="submit" id="submit-btn">Sign in</button>
          <button type="button" class="ghost-btn" id="toggle-mode-btn">Need an account? Register</button>
        </form>
        <div class="status" id="status"></div>
      </div>
    </div>

    <script>
      const form = document.getElementById('login-form');
      const statusEl = document.getElementById('status');
      const toggleModeBtn = document.getElementById('toggle-mode-btn');
      const registerFields = document.getElementById('register-fields');
      const fullNameInput = document.getElementById('full_name');
      const roleSelect = document.getElementById('role');
      let authMode = 'login';

      const setStatus = (message, isError = false) => {
        statusEl.textContent = message || '';
        statusEl.className = 'status ' + (isError ? 'error' : 'success');
      };

      const setAuthMode = (mode) => {
        authMode = mode;
        const isRegister = mode === 'register';
        registerFields.classList.toggle('hidden', !isRegister);
        document.getElementById('submit-btn').textContent = isRegister ? 'Create account' : 'Sign in';
        toggleModeBtn.textContent = isRegister ? 'Have an account? Sign in' : 'Need an account? Register';
        setStatus(isRegister ? 'Create a new account.' : 'Enter your credentials to continue.');
      };

      const checkExistingSession = async () => {
        try {
          const resp = await fetch('/auth/me', { credentials: 'include' });
          if (resp.ok) {
            window.location.href = '/static/index.html';
          }
        } catch (err) {
          console.warn('Session check failed', err);
        }
      };

      const login = async (email, password) => {
        const response = await fetch('/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email, password }),
        });
        if (!response.ok) {
          const detail = await response.json().catch(() => ({}));
          throw new Error(detail.detail || `HTTP ${response.status}`);
        }
      };

      const registerAccount = async ({ email, password, full_name, role }) => {
        const response = await fetch('/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email, password, full_name, role }),
        });
        if (!response.ok) {
          const detail = await response.json().catch(() => ({}));
          throw new Error(detail.detail || `HTTP ${response.status}`);
        }
      };

      toggleModeBtn.addEventListener('click', () => {
        setAuthMode(authMode === 'login' ? 'register' : 'login');
      });

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        if (!email || !password) return;

        try {
          if (authMode === 'register') {
            const full_name = fullNameInput.value.trim();
            const role = roleSelect.value || 'MANAGER';
            if (!full_name) {
              setStatus('Please enter your full name to register.', true);
              return;
            }
            setStatus('Creating your account...');
            await registerAccount({ email, password, full_name, role });
            setStatus('Account created. Signing you in...');
          } else {
            setStatus('Signing in...');
          }
          await login(email, password);
          window.location.href = '/static/index.html';
        } catch (err) {
          console.error(err);
          setStatus(err.message || 'Authentication failed', true);
        }
      });

      setAuthMode('login');
      checkExistingSession();
    </script>
  </body>
</html>
